---
complexity_score: 50.5
converted_at: '2025-08-13T06:59:42.712159Z'
file_type: html
format: html
image_processing_enhanced: true
images_extracted: 5
images_saved: 3
original_path: 42_1553-LZA7016014_1Uen.FE.html
pictures_extracted: 5
processing_method: docling_multimodal
quality_score: 9.0
source_file: 42_1553-LZA7016014_1Uen.FE.html
source_zip: en_lzn7931020_r50f.zip
tables_extracted: 84
zip_image_types:
- .svg
- .png
- .gif
- .jpg
- .bmp
zip_images_total: 1244
---

# 

Manage IPsec

Baseband Radio Node

Contents

![Image](../images/42_1553-LZA7016014_1Uen.FE/additional_3_CP.png)

![Image](../images/42_1553-LZA7016014_1Uen.FE/additional_3_CP.png)

- Description
    - IPsec Overview
    - Managed Object Model Overview
- IPsec Configuration Procedures
    - Configuration Flow
    - Required Configuration of the Security Gateway
    - Certificate Management
    - Typical IPsec Configurations
    - Additional Functions
    - Additional IPsec Configurations
    - Direct IPsec for X2 and Xn
- Troubleshoot IPsec
    - Useful Troubleshooting Commands
    - Log Handling
- Appendix
    - IPsec COMCLI Show-config, Configuration Examples

# 1 Description

## 1.1 IPsec Overview

IPsec is a licensed feature.

The node supports IPsec using Encapsulating Security Payload (ESP) tunnel mode for node

terminated traffic. As such, it follows terms as defined in the relevant RFCs in the area (RFC

4301, RFC 4303 and RFC 7296). However, the following terms and concepts are not

specified in those specifications:

- IPsec VPN connection
- Inner and outer networks
- Vendor credentials

IPsec VPN Connection, Inner and Outer Network

Figure 1 illustrates the typical usage of IPsec.

Figure 1   IPsec Example Setup

The following different networks are used:

- One outer network being the untrusted network that provides the transport to and from the Baseband Radio Node.
- Two inner networks being the trusted networks. One for user and control plane, for example, S1, X2, Iub, or Abis, and one for OAM.

The inner and outer networks are completely separated and use their own addressing and

routing. The Baseband Radio Node has one local address in each network.

The transport of the inner traffic over the outer network is done through an IPsec VPN

connection. An IPsec VPN connection consists of one IKE SA and one or more Child SA pairs.

The IPsec VPN connection is defined by the two endpoints in the outer network. Therefore,

two IPsec VPN connections cannot share the same pair of local and remote addresses in the

outer network.

Figure 1 illustrates an IPsec setup in which the RBS

has two IPsec VPN connections, one for each inner network. Both share the local outer

address, but use different remote outer addresses (SEGs).

Any of the following combinations of IPv4 and IPv6 addresses is possible in the inner and

outer networks for an IPsec VPN connection:

- Only IPv4 address for both networks.
- Only IPv6 address for both networks.
- IPv4 address in one network and IPv6 address in the other network.
- Either IPv4 or IPv6 address in the outer network and both IPv4 and IPv6 addresses in the inner network.

IPsec NAT traversal is supported if IPv4 is used in the outer network. In that case, the

Baseband Radio Node can be behind a NAT device.

IPsec During Autointegration

For more information about IPsec during integration, see Integration Infrastructure Guidelines.

Vendor Credentials

When the Baseband-based node is produced at an Ericsson factory, it is preloaded with unique

Ericsson keys and certificates called vendor credentials.

The vendor credentials are used in the initial integration phase before the credentials

issued by the management system of the operator are downloaded to the node.

The vendor credentials are used when the node authenticates to the security gateway and it

proves that it is genuine Ericsson equipment.

## 1.2 Managed Object Model Overview

IPsec is configured using several MOs placed under the Transport MO. For

more information, see the applicable MOM.

Figure 2   The MOM Class Hierarchy

The configuration of IPsec can be divided into three parts:

- The outer network is configured just like a non-IPsec configuration. It uses a VR on its own represented by the outer Router MO instance. An extra PeerIPv4 or PeerIPv6 MO is added under the outer Router MO instance to specify the outer address of the Security Gateway. In Figure 2, the InterfaceIPv4 or InterfaceIPv6 MO for the local outer address encapsulates an EthernetPort MO. However, it can have any encapsulation except an IpsecTunnel MO (for example, a VlanPort MO, a LagPort MO, or a Bridge MO). It is also possible for the InterfaceIPv4 or InterfaceIPv6 MO to be a loopback interface.
- The inner network is configured using a separate VR represented by the inner Router MO instance. It is configured just like any Router MO instance with the following differences: The encapsulation used by the InterfaceIPv4 or InterfaceIPv6 MO in the inner network is an IpsecTunnel MO. The IpsecTunnel MO represents an IPsec VPN connection and points at the two endpoints in the outer network, AddressIPv4 or AddressIPv6 for the local endpoint and PeerIPv4 or PeerIPv6 for the remote endpoint. A local inner address is configured using an AddressIPv4 with a /32 subnet mask or an AddressIPv6 with a /128 subnet mask. That is, it is a single IP address. In Figure 2, the AddressIPv4 or AddressIPv6 local inner address is configured as a child to the tunnel InterfaceIPv4 or InterfaceIPv6 MO. However, it can be configured as a child to a loopback InterfaceIPv4 or InterfaceIPv6 MO in the inner Router MO instead. By this it is possible to create a redundancy configuration, or to configure more than one local inner address in an inner Router MO. The NextHop MO specifies the tunnel InterfaceIPv4 or InterfaceIPv6 MO in the inner network as next hop rather than an address of a default router.
- The security aspects of IPsec are divided into the following MOs: The IpsecPolicy MO specifies which traffic is allowed through the IPsec VPN connection by the traffic selector configuration. The IpsecPolicy MO also refers to an instance of the IpsecProposalProfile MO, which defines the allowed cryptographic algorithms and the allowed lifetime for the Child SA. The Ikev2Session MO specifies that IKEv2 has to be used as control and key exchange protocol and also specifies some of the properties for the IKE SA. It refers to an Ikev2PolicyProfile MO that specifies the allowed cryptographic algorithms, the allowed lifetime, and the Dead Peer Detection time for the IKE SA. If certificate-based authentication is used, the Ikev2PolicyProfile MO refers to a NodeCredential MO (specifying the node certificate that should be used) and a TrustCategory MO (specifying the trusted certificate that should be used). These MOs are used for handling certificates in the node regardless of being used for IPsec or O&amp;M security. For more information about certificate handling, see Manage Security. Each Ikev2PolicyProfile MO can refer to different NodeCredential and TrustCategory MOs. This makes it possible to have different node certificates and trusted certificates for different IPsec VPN connections. This can be used, for example, to have one trusted certificate for the configured IPsec VPN connections to security gateways and another for direct IPsec VPN connections for X2 and Xn.

There are two additional IPsec-related MOs. The PeerIpsecProfile and

PeerIpsecTunnel MOs are used when the node is configured to establish

direct IPsec VPN connections

for

X2 and Xn.

Related Information

Direct IPsec for X2 and Xn

# 2 IPsec Configuration Procedures

## 2.1 Configuration Flow

The configuration flow consists of creating the following files:

- A configuration template file that can be reused for multiple nodes
- A site-specific configuration file, which is created by populating the template file with site-specific parameters

Template files can be created in one of the following ways:

- Using the Configuration Generator for automatic template creation with the ECT or a plug-in in the Auto Provisioning application of the ENM.
- Creating new XML NETCONF files.

The preferred procedure is to use the Configuration Generator. Only edit the template file

with an XML editor if the required configuration is not supported by the tool.

When the preferred configuration procedure is used, it is not necessary to understand the MO

structure. However, for maintenance and troubleshooting, the MO structure must be

understood.

For more information on configuration methods, see Manage Equipment Configuration Tool. For more information on

configuration files, see Manage Configuration Files.

### 2.1.1 Description of IPsec Configuration with the ECT

The ECT generates a Netconf configuration file with the required MO elements based on GUI

input parameters.

The following section describes the MO classes that are relevant for configuring basic

IPsec configuration in ECT. Additional more advanced IPsec configurations can be also

created by ECT. For other MO classes within the Transport MO, see Manage Transport Network.

Each Router defined in the GUI can have multiple InterfaceIPvX

created. Physical InterfaceIPvX can have multiple

AddressIPvX created. Each IPsec Interface can have custom

IpsecPolicy defined. User can also modify the

RoutingTableIPvXStatic by using Advanced static

routing option (which will trigger creation of multiple

Dst and NextHop instances with IDs different

than the default ones). This example describes a simple case when there is just one

instance of InterfaceIPvX, and one instance of

AddressIPvX created in both inner and outer router.

IpsecPolicy is not customized and the one defined by ECT allows

the single local address and all remote addresses of the specified address family.

Moreover Advanced static routing is not used. The created

configuration is as shown in Figure 3.

Figure 3   MO Structure of Router Settings with a Single IP Interface

If at least one Router MO with an IPsec interface is included in the

configuration, the ECT creates an instance of the Ikev2PolicyProfile

and IpsecProposalProfile MOs.

Table 1   MO Instance Names for the Configuration with a Single IP Interface

| MO Class                                                                         | Instance Name                                                                                                                                                            |
|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| IpsecProposalProfile                                                             | 1                                                                                                                                                                        |
| Ikev2PolicyProfile                                                               | 1                                                                                                                                                                        |
| Router                                                                           | <Router_Identity>  Parameter set in ECT GUII                                                                                                                             |
| InterfaceIPv4 or                                 InterfaceIPv6                   | <Interface_Identity>  Parameter set in ECT GUI                                                                                                                           |
| AddressIPv4 or AddressIPv6                                                       | For Inner router: 1  For Outer router: <Address_Identity>  Parameter in ECT GUI                                                                                          |
| RouteTableIPv4Static or                                     RouteTableIPv6Static | 1                                                                                                                                                                        |
| Dst                                                                              | default                                                                                                                                                                  |
| NextHop                                                                          | 1                                                                                                                                                                        |
| DnsClient                                                                        | 1                                                                                                                                                                        |
| IpsecTunnel                                                                      | <Interface_Identity>  Parameter set in ECT GUI  Interface_Identity taken from the definition of the Inner IPsec                                 interface                |
| PeerIPv4 or PeerIPv6                                                             | <Router identity>.VPN<Interface_Identity>  Router_Identity and Interface_Identity taken from the definition of                                 the Inner IPsec interface |
| Ikev2Session                                                                     | 1                                                                                                                                                                        |
| IpsecPolicy                                                                      | 1                                                                                                                                                                        |

## 2.2 Required Configuration of the Security Gateway

Before the integration of the node start, the security gateway must be preconfigured. The

following is a description of necessary security gateway configuration in case

certificate-based authentication is used. For more information about the security gateway

configuration, see the product documentation for the security gateway product being used.

1. To validate the certificate of the node, the security gateway must have a trusted certificate installed that matches the certificate authority that signed the certificate of the node. The security gateway terminating the IPsec VPN connection used for the O&amp;M traffic must also have the Ericsson Vendor Credential trusted certificate installed. The only exception is if the node certificate is issued by a certificate authority in the untrusted network.
2. The security gateway must be configured with a certificate where the subjectAltName specifies a unique IP address or an FQDN. Furthermore the security gateway must be configured such that the generated IKE ID is identical to the content of the subjectAltName or the subject field in the certificate.
3. The Baseband-based node is working in IKE initiator mode only (that is, it is the Baseband-based node that initiates the setup of an IKE session). Thus the security gateway must be configured in IKE responder mode (accepting request for an IKE session that is initiated by the Baseband-based node).
4. If IKEv2 fragmentation is to be used, it must be enabled on the security gateway.
5. If the Inner address of the node is manually assigned, the security gateway cannot have a configuration mandating the usage of IKEv2 configuration payload. Also, the security gateway must support IKEv2 configuration payload for the inner address of the node to be assigned with IKEv2 configuration payload.
6. If an address used by the NR application is allocated by using IKEv2 configuration payload, the address proposed by the Baseband-based node must be accepted by the security gateway. The reason is that the address must not change after it is initially allocated at Baseband-based node restart.
7. The security gateway must be configured to accept a received IKE ID that is identical to the subjectAltName field of the certificate of the node. Note: If there are more IPsec VPN connections in the node, such as in Configuration B or C, this can require that the security gateway is configured to accept a received IKE ID that is identical to the subject field of the certificate of the node.
8. Normally the security gateway is configured to accept the traffic selector proposal that is proposed by the node without any modifications. It is also possible to restrict the traffic by applying a more advanced policy configuration.
9. Both endpoints are able to initiate IKE and Child SA rekeying but the node and the security gateway must be configured in such way that only one endpoint initiates rekeying. This is done by configuring different lifetime. Thus the IKE SA and Child SA lifetime on the security gateway is configured to either a smaller value or larger value than the corresponding configuration at the node.
10. The security gateway must be configured with the acceptable cryptographic algorithms.
11. The security gateway must support PFS if the node is configured to use PFS. If the node is configured not to use PFS, the security gateway cannot be configured to require PFS.
12. The security gateway must support NAT traversal if the node is behind a NAT device.
13. If pre-shared key is used instead of certificate-based authentication, the corresponding pre-shared key must be configured in both the node and the security gateway. In this case, the IKE ID used by the security gateway must be the outer IP address.

For more information on integration, see Integrate Baseband Radio Node.

Related Information

Configuration B

Configuration C

Configure Cryptographic Algorithms

## 2.3 Certificate Management

IPsec normally requires that there is an enrolled IPsec certificate

and installed trusted certificates in the node. This is handled in

a generic way for both OAM and IPsec related certificates, see Manage Security.  There are however a few IPsec unique aspects

of these procedures as follows:

- When enrolling an IPsec certificate, the certificate should contain the subjectAltName extension and this field should be set to either an IP address or an FQDN. The IKE ID generated from the node will by default be identical to this field.
- The enrollment of certificates, installation of trusted certificates and download of certificate revocation lists can be done in the trusted network behind security gateway, or in the untrusted network. For more information, see Manage Security.
- If the operator IPsec certificate is enrolled from the trusted network, the initial IPsec VPN connection cannot be authenticated using the operator IPsec certificate. For that purpose, the node initially uses vendor credentials to authenticate the OAM IPsec VPN connection. Once the operator IPsec certificate is installed in the node, the IPsec VPN connection will be re-authenticated using the operator IPsec certificate.

## 2.4 Typical IPsec Configurations

The following IPsec configurations can be used as templates, to prepare site basic

configuration files. They include three basic configuration scenarios:

- Configuration A, with one IPsec VPN connection for all the node traffic, and VR separation between the inner and outer network.
- Configuration B, with one IPsec VPN connection for OAM traffic, and one for user and control plane traffic. It also includes one outer VR and two inner VRs, one for OAM traffic and one for user and control plane traffic.
- Configuration C, with one IPsec VPN connection for OAM traffic, and one for user and control plane traffic. The outer network is separated into one outer VR for OAM traffic, and one for user and control plane traffic.

Configuration files for these three typical IPsec configurations can be generated with the

ECT.

IPsec and VR are optional, license-activated features. However, these features are required

to run IPsec and to separate the outer and inner networks with a VR.

Activation of IPsec, VR, and IPv6 is included in the configuration files generated by

ECT.

For more information about license handling, see Manage Licenses and Hardware Activation Codes.

The LTE eNodeB-specific MO classes, SctpEndPoint and

ENodeBFunction, are also shown in these three configurations. The

configuration can be adapted to any of the RATs supported by the node. This is done by

replacing the SctpEndPoint and ENodeBFunction MO

instances with MO class that correspond the other RAT. These MO classes are not included in

the configuration files generated by ECT, when creating the inner Router.

### 2.4.1 Configuration A

In Configuration A, one IPsec VPN connection is used for OAM, as well as user and control

planes. Inner and outer networks are separated into different VRs. Three IP addresses in the

outer networks are of interest to the configuration:

- A1 is the local outer address in the Baseband-based node.
- A2 is the address of the default router.
- A3 is the outer address of the security gateway.

A1 and A2 must be on the same network and thus use the same prefix

length (denoted P1).

The

following

are the two inner addresses of

the

configuration:

- B1 is the local inner address in the Baseband-based node.
- B2 is the address of the DNS server located in the inner network.

Figure 4   Configuration A

Parameter Settings with the ECT

The following parameters can be used in the ECT GUI to setup IPsec Configuration A:

Table 2   General Settings

| Parameter           | Value   |
|---------------------|---------|
| Router used for OAM | MyInner |

Table 3   Port Settings

| Parameter        | Value                |
|------------------|----------------------|
| Port Identity    | TN_A (or other port) |
| Auto-negotiation | Enabled              |

Table 4   Router Settings

| Parameter             | Value Instance 1   | Value Instance 2   |
|-----------------------|--------------------|--------------------|
| Router identity       | MyOuter            | MyInner            |
| Number of DNS servers | N/A                | 1                  |
| Interface type        | Physical interface | Ipsec interface    |
| IP version            | IPv4 or IPv6       | IPv4 or IPv6       |
| Physical connector    | TN_A               | N/A                |
| Use Vlan              | Disabled           | N/A                |
| Used outer router     | N/A                | MyOuter            |

MO Configurations

MO configurations are used to fulfill the configuration requirements of IPsec.

Figure 5   Configuration A Steps

The configuration process can be divided into the following steps:

1. Configuring and starting the enrollment or installation of certificates and global IPsec properties.
2. Configuring the physical interfaces.
3. Configuring the outer network.
4. Configuring the IPsec VPN connection and the inner network.

Table 5   Configuration A

|   Step | MO                                                               | Comment                                                                                                                                                                                                          |
|--------|------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|      1 | NodeCredential                                                   |                                                                                                                                                                                                                  |
|      1 | TrustCategory                                                    |                                                                                                                                                                                                                  |
|      1 | Ikev2PolicyProfile                                               | credential = reference to the                     NodeCredential created previously.  trustCategory = reference to the TrustCategory                 created previously.                                         |
|      1 | IpsecProposalProfile                                             |                                                                                                                                                                                                                  |
|      2 | TnPort                                                           | For more info, see Manage Transport Network                                                                                                                                                                      |
|      2 | EthernetPort                                                     | For more info, see Manage Transport Network                                                                                                                                                                      |
|      2 | VlanPort                                                         | isTagged=false  encapsulation= reference to the                     EthernetPort MO instance created earlier.                                                                                                    |
|      3 | Router                                                           |                                                                                                                                                                                                                  |
|      3 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the VlanPort MO                   instance created earlier.                                                                                                                         |
|      3 | AddressIPv4 or AddressIPv6                                       | address = A1 /P1                                                                                                                                                                                                 |
|      3 | RouteTableIPv4Static or                     RouteTableIPv6Static |                                                                                                                                                                                                                  |
|      3 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0  (IPv6) (default route)                                                                                                                                                           |
|      3 | NextHop                                                          | address = A2                                                                                                                                                                                                     |
|      4 | PeerIPv4 or PeerIPv6                                             | address = A3                                                                                                                                                                                                     |
|      4 | Router                                                           |                                                                                                                                                                                                                  |
|      4 | IpsecTunnel                                                      | localAddress = reference to the AddressIPv4                   or AddressIPv6 MO created under the outer Router.    remoteAddress = reference to the PeerIPv4 or                     PeerIPv6 created previously. |
|      4 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the IpsecTunnel                   created previously.                                                                                                                               |
|      4 | AddressIPv4 or AddressIPv6                                       | address = B1/32 (IPv4) or B1/128 (IPv6)                                                                                                                                                                          |
|      4 | RouteTableIPv4Static or                     RouteTableIPv6Static |                                                                                                                                                                                                                  |
|      4 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0 (IPv6) (default route)                                                                                                                                                            |
|      4 | NextHop                                                          | reference = valid reference to the inner                     InterfaceIPv4 or InterfaceIPv6 created                   previously.                                                                                |
|      4 | DnsClient                                                        | serverAddress =B2                                                                                                                                                                                                |
|      4 | IpsecPolicy                                                      | ipsecProposalProfile = reference to the                     IpsecProposalProfile created previously.                                                                                                             |
|      4 | Ikev2Session                                                     | ikev2PolicyProfile = reference to the                     Ikev2PolicyProfile created previously.                                                                                                                 |
|      4 | OamAccessPoint                                                   | accessPoint = reference to AddressIPv4 or                     AddressIPv6 carrying the B1 address.                                                                                                               |
|      4 | ENodeBFunction                                                   | upIpAddressRef = reference to the                     AddressIPv4 or AddressIPv6 carrying the B1                   address.                                                                                      |
|      4 | SctpEndpoint                                                     | localIpaddress = reference to the                     AddressIPv4 or AddressIPv6 carrying the B1                   address.                                                                                      |

Related Information

Required Configuration of the Security Gateway

### 2.4.2 Configuration B

In Configuration B, one IPsec VPN connection is used for OAM and another for user and control

plane. The two inner networks (one for OAM, and one for user and control plane) and the outer

networks are separated into three different VRs. The following IP addresses in the outer

network are of interest to the configuration:

- A1 is the local outer address in the Baseband-based node.
- A2 is the address of the default router.
- A3 is the outer address of the security gateway used for the OAM traffic.
- A4 is the outer address of the security gateway used for the user/control plane traffic.

A1 and A2 must be on the same network and thus use the same prefix length (denoted P1).

There are three inner addresses of interest to the configuration:

- B1 is the local inner OAM address in the Baseband-based node.
- B2 is the address of the DNS server located in the inner OAM network.
- B3 is the local inner user/control plane address in the Baseband-based node.

Figure 6   Configuration B

Parameter Settings with the ECT

The following parameters can be used in the ECT GUI to setup IPsec Configuration B:

Table 6   General Settings

| Parameter           | Value   |
|---------------------|---------|
| Router used for OAM | OAM     |

Table 7   Port Settings

| Parameter        | Value                |
|------------------|----------------------|
| Port Identity    | TN_A (or other port) |
| Auto-negotiation | Enabled              |

Table 8   Router Settings

| Parameter             | Value Instance 1   | Value Instance 2   | Value Instance 3   |
|-----------------------|--------------------|--------------------|--------------------|
| Router identity       | MyOuter            | OAM                | TRAFFIC            |
| Number of DNS servers | N/A                | 1                  | N/A                |
| Interface type        | Physical interface | Ipsec interface    | Ipsec interface    |
| IP version            | IPv4 or IPv6       | IPv4 or IPv6       | IPv4 or IPv6       |
| Physical connector    | TN_A               | N/A                | N/A                |
| Use VLAN              | Disabled           | N/A                | N/A                |
| Used outer router     | N/A                | MyOuter            | MyOuter            |

MO Configurations

MO configurations are used to fulfill the configuration requirements of IPsec.

Figure 7   Configuration B Steps

The configuration can be divided into the following steps:

1. Configuring and starting enrollment or installation of certificates and global IPsec properties.
2. Configuring the physical interfaces.
3. Configuring the outer network.
4. Configuring the IPsec VPN connection for OAM and the inner OAM network.
5. Configuring the IPsec VPN connection for user/control plane and the inner user/control plane network.

Table 9   Configuration B

|   Step | MO                                                               | Comment                                                                                                                                                                                                                      |
|--------|------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|      1 | NodeCredential                                                   |                                                                                                                                                                                                                              |
|      1 | TrustCategory                                                    |                                                                                                                                                                                                                              |
|      1 | Ikev2PolicyProfile                                               | credential = reference to the NodeCredential                 created previously.  trustCategory = reference to the TrustCategory                 created previously.                                                         |
|      1 | IpsecProposalProfile                                             |                                                                                                                                                                                                                              |
|      2 | TnPort                                                           | For more info, see Manage Transport Network                                                                                                                                                                                  |
|      2 | EthernetPort                                                     | For more info, see Manage Transport Network                                                                                                                                                                                  |
|      2 | VlanPort                                                         | isTagged=false  encapsulation= reference to the                   EthernetPort MO instance created earlier.                                                                                                                  |
|      3 | Router                                                           |                                                                                                                                                                                                                              |
|      3 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the VlanPort MO instance created earlier.                                                                                                                                                       |
|      3 | AddressIPv4 or AddressIPv6                                       | address = A1 /P1                                                                                                                                                                                                             |
|      3 | RouteTableIPv4Static or                     RouteTableIPv6Static |                                                                                                                                                                                                                              |
|      3 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0  (IPv6) (default route)                                                                                                                                                                       |
|      3 | NextHop                                                          | address = A2                                                                                                                                                                                                                 |
|      4 | PeerIPv4 or PeerIPv6                                             | address = A3                                                                                                                                                                                                                 |
|      4 | Router                                                           |                                                                                                                                                                                                                              |
|      4 | IpsecTunnel                                                      | localAddress = reference to the AddressIPv4                   or AddressIPv6 MO created under the outer Router.    remoteAddress = reference to the PeerIPv4 or                     PeerIPv6 created for OAM previously.     |
|      4 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the                     IpsecTunnel created for OAM previously.                                                                                                                                 |
|      4 | AddressIPv4 or AddressIPv6                                       | address = B1/32 (IPv4) or B1/128 (IPv6)                                                                                                                                                                                      |
|      4 | RouteTableIPv4Static or                     RouteTableIPv6Static |                                                                                                                                                                                                                              |
|      4 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0 (IPv6) (the default route)                                                                                                                                                                    |
|      4 | NextHop                                                          | reference = reference to the inner                     InterfaceIPv4 or InterfaceIPv6 created for                   OAM previously.                                                                                          |
|      4 | DnsClient                                                        | serverAddress = B2                                                                                                                                                                                                           |
|      4 | IpsecPolicy                                                      | ipsecProposalProfile = reference to the                     IpsecProposalProfile created previously                                                                                                                          |
|      4 | Ikev2Session                                                     | Ikev2PolicyProfile = reference to the                     Ikev2PolicyProfile created previously.                                                                                                                             |
|      4 | OamAccessPoint                                                   | accessPoint = reference to AddressIPv4 or                     AddressIPv6 carrying the B1 address.                                                                                                                           |
|      5 | PeerIPv4 or PeerIPv6                                             | address = A4                                                                                                                                                                                                                 |
|      5 | Router                                                           |                                                                                                                                                                                                                              |
|      5 | IpsecTunnel                                                      | localAddress = reference to the AddressIPv4                   or AddressIPv6 MO created under the outer Router.    remoteAddress = reference to the PeerIPv4 or                     PeerIPv6 created for user/control plane. |
|      5 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the IpsecTunnel                   created for user/control plane.                                                                                                                               |
|      5 | AddressIPv4 or AddressIPv6                                       | address = B3/32 (IPv4) or B3/128 (IPv6)                                                                                                                                                                                      |
|      5 | RouteTableIPv4Static or                     RouteTableIPv6Static |                                                                                                                                                                                                                              |
|      5 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0 (IPv6) (the default route)                                                                                                                                                                    |
|      5 | NextHop                                                          | reference = reference to the inner                     InterfaceIPv4 or InterfaceIPv6 created for                   user/control plane.                                                                                      |
|      5 | IpsecPolicy                                                      | ipsecProposalProfile = reference to the                     IpsecProposalProfile created previously.                                                                                                                         |
|      5 | Ikev2Session                                                     | ikev2PolicyProfile = reference to the                     Ikev2PolicyProfile created previously.                                                                                                                             |
|      5 | ENodeBFunction                                                   | upIpAddressRef = reference to the                     AddressIPv4 or AddressIPv6 carrying the B3                   address.                                                                                                  |
|      5 | SctpEndpoint                                                     | localIpaddress = reference to the                     AddressIPv4 or AddressIPv6 carrying the B3                   address.                                                                                                  |

Different IP versions can be used for the different IPsec VPN connections. Different IP

versions can be used in inner and outer network.

Related Information

Required Configuration of the Security Gateway

### 2.4.3 Configuration C

In Configuration C, one IPsec VPN connection is used for OAM and another IPsec VPN connection

is used for user and control plane. The two inner networks (one for OAM, and one for user and

control plane) and the outer network are separated into different VRs. Furthermore, the outer

network is separated into one outer network for OAM and one for user/control plane with

different VRs, so, in total, there are four VRs.

The

following IP addresses in the outer networks are of interest to the

configuration:

- A1 is the local OAM outer address in the Baseband-based node.
- A2 is the address of the default router for OAM traffic.
- A3 is the outer address of the security gateway used for the OAM traffic.
- A4 is the outer address of the security gateway used for the user/control plane traffic.
- A5 is the local user/control plane outer address in the Baseband-based node.
- A6 is the address of the default router for user/control plane traffic.

A1 and A2 must be on the same network and thus use the same prefix

length (denoted P1). A5 and A6 must be on the same network and thus use the

same prefix

length (denoted P2).

The two outer networks are separated by VLAN in the node. The OAM outer network uses VLAN ID

= V1 and the user/control plane uses VLAN ID = V2.

There are three inner addresses of interest to the configuration:

- B1 is the local inner OAM address in the Baseband-based node.
- B2 is the address of the DNS server located in the inner OAM network.
- B3 is the local inner user/control plane address in the Baseband-based node.

Figure 8   Configuration C

Parameter Settings with the ECT

The following parameters can be used in the ECT GUI to setup IPsec Configuration C:

Table 10   General Settings

| Parameter           | Value   |
|---------------------|---------|
| Router used for OAM | OAM     |

Table 11   Port Settings

| Parameter        | Value                |
|------------------|----------------------|
| Port Identity    | TN_A (or other port) |
| Auto-negotiation | Enabled              |

Table 12   Router Settings

| Parameter             | Value Instance 1   | Value Instance 2   | Value Instance 3   | Value Instance 4   |
|-----------------------|--------------------|--------------------|--------------------|--------------------|
| Router identity       | OuterOAM           | OAM                | OuterTRAFFIC       | TRAFFIC            |
| Number of DNS servers | N/A                | 1                  | N/A                | N/A                |
| Interface type        | Physical interface | Ipsec interface    | Physical interface | Ipsec interface    |
| IP version            | IPv4 or IPv6       | IPv4 or IPv6       | IPv4 or IPv6       | IPv4 or IPv6       |
| Physical connector    | TN_A               | N/A                | TN_A               | N/A                |
| Use Vlan              | Enabled            | N/A                | Enabled            | N/A                |
| Used outer router     |                    | OuterOAM           | N/A                | OuterTRAFFIC       |

MO Configurations

MO configurations are used to fulfill the configuration requirements of IPsec.

Figure 9   Configuration C Steps

The configuration can be divided into the following steps:

1. Configuring and starting enrollment or installation of certificates and global IPsec properties.
2. Configuring the physical interfaces.
3. Configuring the outer OAM network.
4. Configuring the IPsec VPN connection for OAM and the inner OAM network.
5. Configuring the outer user/control plane network.
6. Configuring the IPsec VPN connection for user/control plane and the inner user/control plane network.

Table 13   Configuration C

|   Step | MO                                                               | Comment                                                                                                                                                                                                                      |
|--------|------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|      1 | NodeCredential                                                   |                                                                                                                                                                                                                              |
|      1 | TrustCategory                                                    |                                                                                                                                                                                                                              |
|      1 | Ikev2PolicyProfile                                               | credential = reference to the                                    NodeCredential created previously.  trustCategory = reference to the TrustCategory                 created previously.                                      |
|      1 | IpsecProposalProfile                                             |                                                                                                                                                                                                                              |
|      2 | TnPort                                                           | For more info, see Manage Transport Network                                                                                                                                                                                  |
|      2 | EthernetPort                                                     | For more info, see Manage Transport Network                                                                                                                                                                                  |
|      3 | VlanPort                                                         | vlanId = V1  encapsulation            = reference to the                     EthernetPort MO instance created earlier.                                                                                                       |
|      3 | Router                                                           |                                                                                                                                                                                                                              |
|      3 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the VlanPort                   with vlanId = V1.                                                                                                                                                |
|      3 | AddressIPv4 or AddressIPv6                                       | address = A1 /P1                                                                                                                                                                                                             |
|      3 | RouteTableIPv4Static or                     RouteTableIPv6Static |                                                                                                                                                                                                                              |
|      3 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0 (IPv6) (the default route)                                                                                                                                                                    |
|      3 | NextHop                                                          | address = A2                                                                                                                                                                                                                 |
|      4 | PeerIPv4 or PeerIPv6                                             | address = A3                                                                                                                                                                                                                 |
|      4 | Router                                                           |                                                                                                                                                                                                                              |
|      4 | IpsecTunnel                                                      | localAddress = reference to the AddressIPv4                   or AddressIPv6 MO created under the outer Router.    remoteAddress = reference to the PeerIPv4 or                     PeerIPv6 created for OAM previously.     |
|      4 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the                     IpsecTunnel created for OAM previously.                                                                                                                                 |
|      4 | AddressIPv4 or AddressIPv6                                       | address = B1/32 (IPv4) or B1/128 (IPv6)                                                                                                                                                                                      |
|      4 | RouteTableStaticIPv4 or                     RouteTableStaticIPv6 |                                                                                                                                                                                                                              |
|      4 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0 (IPv6) (default route)                                                                                                                                                                        |
|      4 | NextHop                                                          | reference = valid reference to the inner                     InterfaceIPv4 or InterfaceIPv6 created                   for OAM previously.                                                                                    |
|      4 | DnsClient                                                        | serverAddress =B2                                                                                                                                                                                                            |
|      4 | IpsecPolicy                                                      | ipsecProposalProfile = reference to the                     IpsecProposalProfile created previously.                                                                                                                         |
|      4 | Ikev2Session                                                     | ikev2PolicyProfile = reference to the                     Ikev2PolicyProfile created previously.                                                                                                                             |
|      4 | OamAccessPoint                                                   | accessPoint = reference to AddressIPv4 or                     AddressIPv6 carrying the B1 address.                                                                                                                           |
|      5 | VlanPort                                                         | vlanId = V2  encapsulation= reference to the                     EthernetPort MO instance created earlier.                                                                                                                   |
|      5 | Router                                                           |                                                                                                                                                                                                                              |
|      5 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the VlanPort                   with vlanId = V2.                                                                                                                                                |
|      5 | AddressIPv4 or AddressIPv6                                       | address = A5 /P2                                                                                                                                                                                                             |
|      5 | RouteTableIPv4Static or                     RouteTableIPv6Static |                                                                                                                                                                                                                              |
|      5 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0 (IPv6) (the default route)                                                                                                                                                                    |
|      5 | NextHop                                                          | address = A6                                                                                                                                                                                                                 |
|      6 | PeerIPv4 or PeerIPv6(1)                                          | address = A4                                                                                                                                                                                                                 |
|      6 | Router                                                           |                                                                                                                                                                                                                              |
|      6 | IpsecTunnel(2)                                                   | localAddress = reference to the AddressIPv4                   or AddressIPv6 MO created under the outer Router.    remoteAddress = reference to the PeerIPv4 or                     PeerIPv6 created for user/control plane. |
|      6 | InterfaceIPv4 or InterfaceIPv6                                   | encapsulation = reference to the                     IpsecTunnel created for user/control plane.                                                                                                                             |
|      6 | AddressIPv4 or AddressIPv6                                       | address = B3/32 (IPv4) or B3/128 (IPv6)                                                                                                                                                                                      |
|      6 | RouteTableIPv4Static or                     RouteTableIPv6Static |                                                                                                                                                                                                                              |
|      6 | Dst                                                              | dst = 0.0.0.0/0 (IPv4) or ::/0 (IPv6) (the default route)                                                                                                                                                                    |
|      6 | NextHop                                                          | reference = reference to the inner                     InterfaceIPv4 or InterfaceIPv6 created for                   user/control plane.                                                                                      |
|      6 | IpsecPolicy                                                      | ipsecProposalProfile = reference to the                     IpsecProposalProfile created previously.                                                                                                                         |
|      6 | Ikev2Session                                                     | ikev2PolicyProfile = reference to the                     Ikev2PolicyProfile created previously.                                                                                                                             |
|      6 | ENodeBFunction                                                   | upIpAddressRef = reference to the                     AddressIPv4 or AddressIPv6 carrying the B3                   address.                                                                                                  |
|      6 | SctpEndpoint                                                     | localIpaddress = reference to the                     AddressIPv4 or AddressIPv6 carrying the B3                   address.                                                                                                  |

(1)

The PeerIPv4 or the PeerIPv6 MO is

located under the Router representing the outer user and

control plane network

(2)

The IpsecTunnel MO references to the

AddressIPv4 or AddressIPv6 carrying

the A5 address.

Different IP versions can be used for the different IPsec VPN connections. Different IP

versions can be used in inner and outer network.

Related Information

Required Configuration of the Security Gateway

## 2.5 Additional Functions

If the functionality is supported by ECT, the information will be stated in the specific

section.

The following two levels of support are possible:

- Explicit support, when the document contains additional information on how to configure the functionality using ECT.
- Custom MO support, when relevant attributes are set using ECT Advanced Configuration Type.

For additional information about Custom MO attributes in ECT, see the Manage Equipment Configuration Tool document.

### 2.5.1 Certificate Expiry and Renewal of IPsec Node Certificate

An IPsec node certificate must be renewed before the lifetime of the certificate expires (or

if the certificate for other reasons

needs

to be revoked). For details about renewal of certificates, see Manage

Security.

An already established IPsec VPN connection is not taken down by the node if the certificate

of the node or the peer expires.

The node does not try to establish new IPsec VPN connections if the node certificate has

expired. The node does not accept a new IPsec VPN connection if the peer certificate has

expired.

### 2.5.2 Changed Installed Trusted Certificates

It is possible to add new trusted certificates and remove existing trusted certificates. For

details see Manage

Security.

### 2.5.3 Multiple IPsec Certificates

It is possible to have

multiple

IPsec node certificates and groups of trusted certificates for separate IPsec VPN

connections. This is done by using different Ikev2PolicyProfile MOs

referring to different NodeCredential and

TrustCategory MOs. Each certificate can be enrolled and installed

from different certificate authority in trusted or untrusted network independently.

ECT enables the creation of up to four different PKI systems, including a certificate

authority in each, and with that four different IPsec node certificates. Each PKI system

enables the creation of up to 10 trusted certificates. They can be defined in the

Transport/PKI system tab of ECT and referred by any IPsec type Interface using optional

PKI system field in the Transport/Router tab.

### 2.5.4 Activate IPsec Certificate Revocation

It is possible to activate revocation check for the IKE peer node certificate by setting

the TrustCategory.crlCheck attribute, referred by the Ikev2PolicyProfile MO, to ACTIVATED. The

revocation check is done each time the IKE SA is established.

The TrustCategory.crlCheck attribute can be set independently on each

TrustCategory MO. By using different

Ikev2PolicyProfile and TrustCategory MOs, it

is possible, for example, to activate certificate revocation for

direct

IPsec

for

X2 and Xn, but leave it deactivated for configured IPsec VPN

connections to the security gateways.

This functionality can be enabled in ECT by setting the Transport/PKI system/Certificate

revocation check slider to enabled.

Related Information

Direct IPsec for X2 and Xn

### 2.5.5 Configure IKEv2 Fragmentation

The fragmentation of large IKEv2 messages can be done by IKEv2 itself. Thus fragmentation

of IKEv2 message at IP level is not needed and network issues caused by IP fragments can

be avoided. By default, IKEv2 fragmentation is not enabled in the Baseband Radio Node

and large IKEv2 messages can be fragmented on IP level instead. For IPv4, the resulting

IP packet size is maximum 576 bytes, and for IPv6 maximum 1280 bytes. IKEv2

fragmentation is not used when establishing the first temporary IPsec VPN connection

during autointegration. IKEv2 fragmentation is only applicable if both peers enable

fragmentation.

IKEv2 fragmentation is enabled on the Baseband Radio Node by setting the

Ikev2PolicyProfile.ikev2Fragmentation attribute to

true. IKEv2 fragmentation must be enabled on the peer nodes as

well.

ECT support is provided by using Custom MO attributes.

### 2.5.6 Configure Dead Peer Detection

By default, the Baseband detects that the peer is dead within 60

seconds. There are two retransmissions of an IKE request if there is no response from

the peer. The first retransmission is sent after 3 seconds and the second one after

another 6 seconds. After another 12 seconds-which is 21 seconds after the first IKE

request-the peer is considered to be dead and the IKE SA is taken down. To detect if the

peer is dead within 60 seconds, a DPD request is sent by no later than 39 seconds after

the last incoming IKE message or ESP traffic.

Figure 10   Default DPD Time of 60 Seconds

Configure DPD Time

The maximum amount of time to detect if the peer is dead can be changed by

configuring the Ikev2PolicyProfile.dpdTime attribute.

Internally, the DPD time is translated into a retransmission scheme and a DPD

interval.

The retransmission scheme consists of:

- Tries: The number of retransmissions.
- Timeout: The time until the first retransmission.
- Base: The exponential backoff for following retransmissions.

The DPD interval is the time between DPD requests when there is no incoming IKE

messages or ESP traffic. To detect the dead peer within the DPD time, the DPD

interval is half of the remaining time between the retransmission period and the DPD

time.

Based on different DPD time configured, the DPD time is translated into one of the

retransmissions schemes shown in Table 14.

Table 14   DPD Configurations

| Ikev2PolicyProfile.dpdTime Value (Seconds)   |   Tries |   Timeout (Seconds) |   Base | Retransmission Period (Seconds)   | DPD Interval (Seconds)   |
|----------------------------------------------|---------|---------------------|--------|-----------------------------------|--------------------------|
| 5–9                                          |       2 |                   1 |      1 | 1+1+1=3                           | 1–3                      |
| 10–19                                        |       2 |                   1 |      2 | 1+2+4=7                           | 1–6                      |
| 20–29                                        |       2 |                   2 |      2 | 2+4+8=14                          | 3–7                      |
| 30–83                                        |       2 |                   3 |      2 | 3+6+12=21                         | 4–31                     |
| 84–131                                       |       3 |                   3 |      2 | 3+6+12+24=45                      | 19–43                    |
| 132–227                                      |       4 |                   3 |      2 | 3+6+12+24+48=93                   | 19–67                    |
| 228–1800                                     |       5 |                   3 |      2 | 3+6+12+24+48+96=189               | 19–805                   |

The increased number of retransmissions based on the DPD time apply to any IKE

request, except for the IKE DELETE request. For the

IKE DELETE request, there are no more than two

retransmissions.

Configure Random Delay

When using DPD time that is less than 10-20 seconds, it is recommended to configure a

random delay between IKE INIT retransmission periods to reduce pressure on the

SEG.

The upper limit of the random delay is configured using

Ikev2PolicyProfile.randomDelay. The upper limit ranges from

15 to 30 seconds. The lower limit is always 10 seconds.

Tune DPD Mechanism

Instead of configuring the DPD time directly by

Ikev2PolicyProfile.dpdTime, tuning the DPD mechanism is an

alternative approach to set DPD time that provides more flexibility. By this way the

Ikev2PolicyProfile.dpdTime attribute is ignored.

To tune the DPD mechanism, configure the retransmission scheme using

Ikev2PolicyProfile.retransmissionScheme attribute and the DPD

interval using Ikev2PolicyProfile.dpdInterval attribute. The

Ikev2PolicyProfile.retransmissionScheme attribute has three

parts that can be configured individually: base, timeout, and tries.

In the case of tuning the DPD mechanism, the DPD time is calculated as follows:

DPD time = 2 * DPD interval + Retransmission period

Where:

Retransmission period = Timeout (Base ^0 + Base ^1 + ... + Base ^ Tries)

Separate DPD Configuration for Each IPsec VPN Connection

By using different Ikev2PolicyProfile MOs, each IPsec VPN

connection can have an individual DPD setting. All direct IPsec VPN connections

within the same inner Router use the same Ikev2PolicyProfile

MO.

ECT Support

ECT support is provided by using Custom MO attributes.

### 2.5.7 Configure Cryptographic Algorithms

By default the node proposes all algorithms it supports to the

SEG

in the IKE negotiation. It is then the

SEG

that decides which algorithms are applied and thus the configuration of desired algorithms can

be done only on the

SEG.

It is possible to configure the node to use specifics algorithms. The algorithms used for the

IKE SA are configured in the attribute Ikev2PolicyProfile.ikev2Proposal.

The algorithms used for the Child SA are configured in the attribute

IpsecProposalProfile.ipsecProposal.

The NULL encryption and the AES\_GMAC combined algorithm on the Child SA are not proposed by

default. If these are desired, they have to be explicitly configured.

The following algorithms are not recommended for security reasons:

- ENCR\_3DES
- AUTH\_HMAC\_SHA1\_96
- AUTH\_AES\_XCBC\_96
- AUTH\_HMAC\_MD5\_96
- PRF\_HMAC\_SHA1
- PRF\_HMAC\_MD5
- Diffie-Hellman group 2

The MD5 algorithms are MUST\_NOT according to the relevant RFCs, and only supported for

backwards compatibility reasons.

Diffie-Hellman group 2 and 14 are not recommended for direct IPsec VPN connections for X2 and

Xn as key generation can be slow.

### 2.5.8 Configure Perfect Forward Secrecy

By default, PFS is not used by the node. This means that the DH group and the DH value

for the IKE SA is used to create the keys for all Child SA pairs.

The node can be configured to use PFS by setting the

IpsecProposalProfile.pfs attribute to TRUE. In

this case, a new DH exchange is done each time a Child SA pair is rekeyed, or an

additional Child SA pair is established. The proposed DH groups are the same as the ones

configured for the IKE SA.

PFS is not supported for

direct

IPsec VPN

connections for X2

and Xn.

ECT support is provided by using Custom MO attributes.

### 2.5.9 Configure SA Lifetime

The node will trigger a rekeying of the IKE and Child SA when 80-90% of the lifetime has been

reached. The default lifetime is 24 hours for both the IKE and Child SA. It is possible to

configure the system with another lifetime by configuring the attribute

Ikev2PolicyProfile.ikeSaLifetime (for the IKE SA) respective the

attribute IpsecProposalProfile.childSaLifetime (for the Child SA).

For the Child SA, it is also possible to configure a byte limit in the attribute

IpsecProposalProfile.childSaLifetime. By default, the byte limit is

switched off. Using a byte limit for Child SA lifetime is not supported for

direct IPsec VPN

connections for X2 and

Xn.

ECT support is provided by using Custom MO attributes.

### 2.5.10 Disable Anti-replay Protection

By default the node will have anti-replay protection enabled, meaning that ESP packets

received with a sequence number that is outside the anti-replay window will be discarded. The

anti-replay window has a fixed value of 1024. In some networks, packets might fall outside the

anti-replay window due to delays caused by the network. In such a case it might be necessary

to disable anti-replay protection. This can be done by setting the

IpsecPolicy.antiReplayProtection attribute.

ECT support is provided by using Custom MO attributes.

### 2.5.11 Using Pre-shared Keys

It is possible to use pre-shared keys instead of certificate-based authentication. In that

case, the Ikev2PolicyProfile.credential and

Ikev2PolicyProfile.trustCategory attributes have to be set to nil. The

configuration of the pre-shared key that must be used is done through the

Ikev2Session.installPreSharedKey action.

The SEG must be configured with the pre-shared key. In addition, the SEG must be configured

to send an IKE identity identical to the IP address of the SEG. It must also be configured to

accept an IKE ID from the other end that is identical to the IP address of that node.

### 2.5.12 Configuring Outer Addresses using DHCP, DHCPv6, SLAAC, and FQDN

The local outer IPv4 address can be dynamically allocated using DHCP. This is done by

setting the AddressIPv4.configurationMode to DHCP

for the AddressIPv4 MO referred by the IpsecTunnel

MO.

The local outer IPv6 address can be dynamically allocated using DHCPv6 or SLAAC. This is

done by setting the the AddressIPv6.configurationMode to

AUTO for the AddressIPv6 MO referred by the

IpsecTunnel MO.

If the outer IP address is configured dynamically, the address can change at any time. In

this case, the IPsec VPN connection using the outer IP address loses the connection to

the peer and the IKE SA is deleted. The new outer IP address initiates a new IKE

negotiation.

When the IP address is changed or the lease expires, any alarm for the

Ikev2Session is ceased.

Until a new IKE SA is established, Ikev2Session,

IpsecTunnel, and inner InterfaceIPv4 or

InterfaceIPv6 are DISABLED.

It is also possible to retrieve the remote outer IP address (to the security gateway)

using an FQDN. This is done by configuring the PeerIPv4.address or

PeerIPv6.address as FQDN for the PeerIPv4 or

PeerIPv6 MO referred by the IpsecTunnel

MO.

The FQDN is translated into one or more IP addresses using DNS each time the IKE

negotiation is to start.

The node supports FQDN translated up to 15 IP addresses. The order of the addresses

received from the DNS server is used as priority, so IKE negotiation is done with one

address at the time until an IKE SA can successfully be established. Dependent on the

DNS server configuration, this can be used for load sharing (different order of

addresses for each DNS query) or a kind of active-standby redundancy.

Dynamically allocated outer addresses can be enabled in ECT by setting the

Transport/Router/Address configuration method to Dynamic. Peer or Security Gateway IP

address is set in CIQ and can either be entered as an IP address or a domain name.

### 2.5.13 Configuring Inner Addresses using IKEv2 Configuration Payload

It is possible to dynamically allocate the local inner IP address using IKEv2

Configuration Payload. To do this, set the

AddressIPv4.configurationMode or the

AddressIPv6.configurationMode to IKE. The

AddressIPv4 or the AddressIPv6 represents the

local inner address. If configuration payload is used to dynamically allocate the inner

IPv4 address, there can be only one AddressIPv4 MO within the

Router and it must be a child to an

InterfaceIPv4 MO encapsulating an IpsecTunnel

MO. The same applies to IPv6 independently.

It is not possible to allocate a local inner address with IKEv2 Configuration Payload if

there are both IPv4 and IPv6 local inner addresses present for an IPsec VPN

connection.

Together with the local inner address, it is possible to also dynamically allocate the

DNS server addresses for a DnsClient MO within the same Router. This

is done by setting the DnsClient.configurationMode to

AUTOMATIC.

A dynamically allocated address is not supported for GSM (Abis). If IKEv2 configuration

payload is used for LTE (S1/X2) or WCDMA (Iub) in a multistandard radio node, GSM have

to use a separate VR with a manually configured inner address.

Dynamically allocated inner address can be enabled in ECT by setting the

Transport/Router/Address configuration method to Dynamic.

### 2.5.14 Configuring Interface State Tracking

Interface state tracking is supported for loopback interfaces by configuring

InterfaceIPv4.trackedInterface or

InterfaceIPv6.trackedInterface. The tracked interface attribute

is a reference to a tunnel InterfaceIPv4 or

InterfaceIPv6 MO in the same inner Router MO.

Based on this, the loopback interface inherits the operational state of the tunnel

interface. The operational state depends on the state of the IPsec VPN connection.

### 2.5.15 Reconfigure IPsec

It is possible to reconfigure IPsec by changing the attributes on the IPsec related MOs.

For details on which attributes can be changed, see Managed Object Model (MOM).

To avoid loss of contact with the node caused by configuration mistakes, it is

recommended to activate the failsafe backup before the reconfiguration. For more

details, see Manage Software.

The reconfiguration causes traffic disturbance for one or more IPsec VPN connections.

When any of the attributes is changed for an MO related to one IPsec VPN connection

(that is IpsecTunnel MO, Ikev2Session MO, and

IpsecPolicy MO), the IKE SA and Child SAs for that IPsec VPN

connection are deleted and re-negotiated again using the new configuration. When any of

the attributes is changed for an MO related to more than one IPsec VPN connections (that

is Ikev2PolicyProfile MO and IpsecProposalProfile

MO), the IKE SA and Child SAs for all concerned IPsec VPN connections are deleted and

re-negotiated again using the new configuration.

The IKE SA and Child SAs are deleted and reestablished again in case of reconfigurations

of other MOs relevant to IPsec. For example, this is the case when changing the

addresses in the inner or outer networks, that is, the

AddressIPv4.address,

AddressIPv6.address, PeerIPv4.address, or the

PeerIPv6.address

MO

attribute.

## 2.6 Additional IPsec Configurations

In the three typical IPsec configurations (Configuration A, B, and C), all traffic in the

node is protected by IPsec either using one or two IPsec VPN connections to one Security

Gateway each. In Configuration B and C, OAM uses another inner VR with one IPsec VPN

connection, and the user and control plane uses another inner VR with one IPsec VPN

connection. All traffic through an IPsec VPN connection is sent using one Child SA pair

(one IPsec policy), and there is one local inner address in each inner network on VR.

One node certificate and one list of trusted certificates are in use for IPsec.

Besides the three typical IPsec configurations, there are many other possible IPsec

configurations.

IPsec can protect only one part of the traffic. For example, Configuration A can be

modified so the IPsec protects only the user and control plane, or only the OAM

traffic.

It is recommended to use separate VRs and different local addresses for protected and

unprotected traffic as well. Through this method, trusted and untrusted networks are

separated. The exposure of the trusted network in the untrusted domain is avoided.

It is also possible to split the traffic further using more VRs, IPsec VPN connections,

and IPsec policies. This can be applied in the following cases:

- Multi-Standard RBS
- Different multi-operator scenarios, like MOCN or MORAN Note: For an example about multi-operator scenarios, see the Multiple IP Addresses for S1 and X2 feature.
- Separation of different interfaces, for example, S1 and X2
- Separation of user and control plane
- IPv4 and IPv6 dual-stack for X2 configuration
- Creating different kinds of redundancy configurations
- Load balancing between different serving Gateways
- Increasing throughput

When using different VRs, no address coordination is needed between the VRs, and

overlapping IP addresses are applicable. With one IPsec VPN connection in each inner VR,

the traffic is directed to different IPsec VPN connections based on the local access

configuration.

Within one VR, there can be multiple local inner addresses as well as multiple IPsec VPN

connections. One local inner address can be used by one or more IPsec VPN connections,

and one IPsec VPN connection can carry traffic for one or more local inner addresses.

How the local inner addresses related to different IPsec VPN connection depends on the

routing and the traffic selectors. The traffic is directed to the following:

- To different IPsec VPN connections, based on the destination or policy routing in the VR
- To different Child SA pairs within an IPsec VPN connection, based on the IPsec policy configuration

It is recommended, and in some cases required, to configure different IPsec policies for

each local inner address. Through this method, one Child SA pair is created for each

local inner address, and possible interoperability problems with different Security

Gateways can be avoided.

It is possible, although not recommended to configure IPsec using one VR (one

Router MO instance) and through that to have a common VR for

outer and inner networks. However, there are a number of negative effects of this kind

of configuration, for example the following:

- No traffic separation between the outer (untrusted) network and the inner (trusted) network
- Some functionality, like dynamic allocation of addresses using DHCP or IKEv2 Configuration Payload is not available

Any combination of inner and outer VRs, IPsec VPN connections, and IPsec policies is

possible as long as the maximum numbers are not exceeded.

With

multiple Ikev2PolicyProfile and

IpsecProposalProfile MOs, different sets of

cryptographic algorithms can be applied for different IPsec VPN connections and IPsec

policies. When using different IKEv2 policy profiles, different node certificates and a

list of trusted certificates can be applied.

Different profiles and trusted certificates can be applied in a multistandard or

multi-operator scenario, or when using direct IPsec for X2 and Xn.

Table 15   Limits for VR, IPsec VPN connection,

IPsec

policy,

IpsecProposalProfile

MO,

and

Ikev2PolicyProfile

MO

| Items                    |   Maximum |
|--------------------------|-----------|
| VRs                      |        60 |
| IPsec VPN connections    |        60 |
| IPsec policies           |       120 |
| IpsecProposalProfile MOs |        60 |
| Ikev2PolicyProfile MOs   |        60 |

Related Information

Configuration A

Configuration B

Configuration C

Multiple Inner Networks

Multiple Local Inner Addresses in One VR

Configuration of Remote Traffic Selectors

Multiple IPsec VPN Connections Sharing an Inner Address

IPsec Connection Redundancy

Direct IPsec for X2 and Xn

### 2.6.1 Multiple Inner Networks

Different VRs can be used to create separate networks and by that separate different

types of traffic. Figure 11 shows

a multistandard scenario with LTE and WCDMA sharing Baseband Radio Node. There is one

common outer network and three inner networks. One inner network is used for OAM traffic

and the other two inner networks used for LTE and WCDMA traffic.

Another example can be two LTE operators sharing the same Baseband Radio Node using

different PLMN identities and different local addresses, or the separation of LTE and

EN-DC X2 traffic.

No address coordination is needed between the different VRs. Overlapping IP addresses can

be applied.

It is possible to use different outer VRs as well.

Figure 11   Separate Inner Networks for Different Applications

One local outer address A is used in the Baseband based node. There are three IPsec VPN

connections to three different Security Gateways with remote outer addresses B-D. Each

IPsec VPN connection is in a separate inner network with separate local inner addresses

E-G.

Figure 12   Configuring Separate Inner Networks for Different Applications

The configuration shown in Figure 12

starts with configuration B to cover the OAM and LTE parts. Then the inner network for

WCDMA is repeating the same actions as for the other IPsec VPN connections. These

actions consist of adding another PeerIPv4 MO under the outer

Router MO, a new inner Router MO with all MOs

needed for the third IPsec VPN connection, and then the NodeBFunction

and SctpEndpoint MOs.

For OAM and S1/X2 inner networks, IPv4 or IPv6 can be used in the inner network and the

local inner address can be manually configured or dynamically allocated using IKEv2

configuration payload.

A third application can be added in the same way as the second application.

No Ikev2PolicyProfile or IpsecProposalProfile MO

configuration is shown in the example. Each Ikev2Session MO refers to

an Ikev2PolicyProfile MO and each IpsecPolicy MO

refers to an IpsecProposalProfile MO. The same profile MOs can be

applied for all three, or different profile MOs can be applied. If different

Ikev2PolicyProfile MOs are applied, different

NodeCredential and TrustCategory MOs can be

applied as well. Through this method, different IPsec node certificates and different

list of trusted certificates can be applied for each standard, or each operator.

In ECT, multiple routers can be configured. A router is identified as an inner IPsec

router if it has at least one IPsec Interface.

Related Information

Configuration B

Configuration C

### 2.6.2 Multiple Local Inner Addresses in One VR

#### 2.6.2.1 Sharing One IPsec VPN Connection

Multiple local inner addresses can be applied if dedicated addresses are needed, for

example for the following:

- Different standards (like LTE and NR EN-DC)
- Operators
- Interfaces (like S1 and X2)
- Control and user plane

With all local addresses in the same inner VR, all traffic can be sent using one IPsec

VPN connection to the security gateway. Through that method, resources can be saved in

the outer network. IPv4 and IPv6 traffic can share the same IPsec VPN connection.

If IPv4 and IPv6 traffic share one IPsec VPN connection, there is one

InterfaceIPv4 MO and one InterfaceIPv6 MO with

the same IpsecTunnel MO in encapsulation. There is also one routing

table for each IP version. In this case there must be an IpsecPolicy

MO for each local inner address with the

IpsecPolicy.localTrafficSelector attribute configured. Additional

local inner addresses of both IP versions can be added using loopback

InterfaceIPv4 or InterfaceIPv6 MOs.

Figure 13   Configure Multiple Inner Addresses with One IPsec VPN Connection

The result of the configuration shown in Figure 13

is that the node establishes one IPsec VPN connection (one IKE SA) with three Child SA

pairs to the security gateway. Each Child SA pair is applied for traffic to and from one

of the local inner addresses.

Figure 14   Multiple Local Inner Addresses Divided on Different Child SA Pairs

Even if all local inner addresses belong to the same IP version, it is still recommended

to configure one IpsecPolicy MO for each local inner address with the

IpsecPolicy.localTrafficSelector attribute. This is to avoid

interoperability problems with the security gateway.

Both loopback interfaces and multiple IPsec Interfaces can be defined in ECT in the same

IPsec Router.

#### 2.6.2.2 Configuring Separate IPsec VPN Connections

Different local inner addresses can be applied for different IPsec VPN connections in the

same inner VR, for example, in different load balancing or SCTP multihoming

scenarios.

In this case, the following configuration applies for each IPsec VPN connection:

- One IpsecTunnel MO
- One Ikev2Session MO
- One IpsecPolicy MO
- One tunnel InterfaceIPv4 or InterfaceIPv6 MO

Each local inner address is configured by an AddressIPv4 or

AddressIPv6 MO. Each AddressIPv4 or

AddressIPv6 MO is a child to one of the following MOs:

- A tunnel InterfaceIPv4 or InterfaceIPv6 MO
- A separate loopback InterfaceIPv4 or InterfaceIPv6 MO

The outgoing traffic is steered to the different IPsec VPN connection based on the

destination routing. There must be separate Dst MOs with different

destination in the Dst.dst attribute for each IPsec VPN

connection.

The relevant local inner address for the IPsec VPN connection is configured in the

IpsecPolicy.localTrafficSelector attribute. This is to include

only the local inner address defined by the

IpsecPolicy.localTrafficSelector attribute in the Child SA

negotiation with the security gateway and to avoid interoperability problems. For more

information about a configuration without setting

IpsecPolicy.localTrafficSelector, see Configuring IPsec VPN Connections without IPsec Policy.

Figure 15   Configure Multiple Inner Addresses with Two IPsec VPN Connections

The result of the configuration shown in Figure 15

is that the node establishes two IPsec VPN connections (two IKE SAs) with one Child SA

pair each towards different security gateways. One connection is valid for traffic to

and from A1 and the other connection is valid for traffic to and from A2. Outgoing

traffic to subnet A is routed to the second (A2) IPsec VPN connection, and all other

outgoing traffic is routed to the first (A1) IPsec connection. This means that outgoing

traffic from A1 to subnet A is discarded, and outgoing traffic from A2 to anything but

subnet A is discarded. Incoming traffic is accepted regardless of the source

address.

Figure 16   Multiple Local Inner Addresses Divided on Different IPsec VPN Connections

In ECT, one IPsec interface corresponds to a single IPsec VPN connection. Multiple IPsec

Interfaces can be defined in the same inner Router.

#### 2.6.2.3 Configuring Separate IPsec VPN Connections Using PBR

Different local inner addresses can be applied for different IPsec VPN connections in the

same inner VR using PBR, for example when using the Multiple IP Addresses for Security Gateway

Resilience feature.

In this case, the following configuration applies for each IPsec VPN connection:

- One IpsecTunnel MO
- One Ikev2Session MO
- One IpsecPolicy MO
- One tunnel InterfaceIPv4 or InterfaceIPv6 MO
- One AddressIPv4 or AddressIPv6 MO

The local inner addresses, or additional local inner addresses, can be configured using

loopback interfaces.

The outgoing traffic is steered to the different IPsec VPN connection based on the

destination routing and PBR. When using PBR, traffic to the same destination can be

routed to different IPsec VPN connections based on the local inner address (the source

address). Combining the destination routing and PBR, traffic for one local inner address

to a specific destination can be routed to one IPsec VPN connection using PBR. Traffic

for the other local inner address to the same destination, and traffic to all other

destinations, can be routed with the destination routing to the other IPsec VPN

connection.

The relevant local inner address for the IPsec VPN connection is configured in the

IpsecPolicy.localTrafficSelector attribute. This is to include

only the local inner address defined by the

IpsecPolicy.localTrafficSelector attribute in the Child SA

negotiation with the security gateway.

Figure 17   Configure Multiple Inner Addresses with Two IPsec VPN Connections with

PBR

The result of the configuration shown in Figure 17

is that the node establishes two IPsec VPN connections (two IKE SAs) with one Child SA

pair each towards different security gateways. One connection is valid for traffic to

and from A1 and the other connection is valid for traffic to and from A2. Outgoing

traffic to subnet A from A2 is routed to the second (A2) IPsec VPN connection. All other

outgoing traffic is routed to the first (A1) IPsec connection, including traffic to

subnet A from A1. Outgoing traffic from A2 to anything but subnet A is discarded.

Incoming traffic is accepted regardless of the source address.

Figure 18   Multiple Local Inner Addresses Divided on Different IPsec VPN Connections with

PBR

#### 2.6.2.4 Configuring IPsec VPN Connections with Default IPsec Policy Configuration

Configuring multiple local inner addresses in one VR without configuring the

IpsecPolicy.localTrafficSelector attribute can lead to

interoperability problems with the security gateway.

By default, the Baseband-based node includes all local inner addresses of the relevant IP

versions in the inner VR, within the proposed traffic selector for the initiator side.

Therefore, if there are multiple local inner addresses present in the inner VR, the

proposed traffic selector for the initiator side contains multiple address ranges.

Figure 19 illustrates a Baseband-based

node with two local inner addresses. At least one of the inner addresses must be

configured using a loopback InterfaceIPv4 or

InterfaceIPv6 MO. One of the InterfaceIPv4 or

InterfaceIPv6 MO classes can encapsulate the

IpsecTunnel MO.

Figure 19   Multiple Local Inner Addresses with Default Configuration

The node sends a proposed traffic selector for initiator side including the A1 and A2

addresses to the security gateway.

There are three different ways a security gateway can respond on a traffic selector:

1. The security gateway accepts the proposed traffic selector.
2. The security gateway only accepts one of the addresses.
3. The security gateway rejects the proposed traffic selector.

In ECT, if the user does not specify policies explicitly, the following will happen:

- If the IPsec interface is configured as either IPv4 or IPv6, ECT will create a policy without configuring the IpsecPolicy.localTrafficSelector attribute, which means all local inner addresses of the relevant IP version in the inner VR will be accepted.
- If the IPsec interface is configured as both IPv4 and IPv6, which means both IPv4 and IPv6 are encapsulated in a single IpsecTunnel MO, ECT will create one policy for each IP version. These policies will have a local traffic selector defined and set to allow all addresses of that IP version.

### 2.6.3 Configuration of Remote Traffic Selectors

By default, no remote traffic selector is configured for an IPsec policy, and the

proposed traffic selector for the responder side in the IKE negotiation is a wildcard.

By configuring the IpsecPolicy.remoteTrafficSelector

attribute, only traffic for the configured address ranges in the trusted network at the

security gateway side is allowed through the corresponding Child SA pair. This

configuration can be applied, for example, to limiting the traffic through an IPsec VPN

connection for security reasons.

Figure 20 shows a configuration including

one subnet (A). It is also possible to configure multiple subnets, but there is a

possibility that the security gateway does not support it.

Figure 20   Traffic Limited by Configuring remoteTrafficSelector in the

Node

By configuring multiple IpsecPolicy MOs for an

IpsecTunnel MO, with different address ranges in the

IpsecPolicy.remoteTrafficSelector attribute, the traffic to

different destinations is separated into different Child SA pairs in the IPsec VPN

connection. For example, this can be applied to avoid anti-relay problems if different

traffic classes are applied towards different destinations.

Figure 21   Traffic to or from Different Subnets on Different Child SA Pairs

Traffic is allowed to different subnets: A, B, and C. The Baseband-based node is

configured with three IpsecPolicy MOs, each of which have the

IpsecPolicy.remoteTrafficSelector attribute set to one of the

three subnets. As a result, three Child SA pairs are established, one for each subnet.

The policy configuration in the security gateway either states that all addresses are

allowed, or that only subnet A, B and C is allowed. The resulting Child SA pairs are the

same regardless of the actual configuration.

Each IpsecPolicy MO has a reference to an

IpsecProposalProfile MO defining the encryption to apply. Thus by

using multiple IpsecPolicy MOs, it is possible to use different

cipher suites for different Child SA pairs. For example, one Child SA pair can use null

encryption while another uses AES-CBC.

Up to 64 IpsecPolicy MOs can be configured in the node.

Multiple IPsec policies cannot be configured if the local inner address is dynamically

allocated using IKEv2 configuration payload.

In ECT, a user can specify how many traffic selector ranges are to be defined for each

IPsec Policy.

### 2.6.4 Multiple IPsec VPN Connections Sharing an Inner Address

It is possible to configure multiple IPsec VPN connections in the same inner VR, sharing

one local inner address. For example, this configuration can be applied for load sharing

and redundancy scenarios.

Figure 22   Multiple IPsec VPN Connections Sharing an Inner Address

In the example shown in Figure 22, one local outer

address (A) is applied in the Baseband-based node. There are two IPsec VPN connections

for two different Security Gateways with remote addresses (B and C). Both IPsec VPN

connections are in the same inner VR and share the same inner address. Traffic is routed

to the different IPsec VPN connection, based on destination routing in the inner VR. The

applicable destinations are the two service Gateways (with addresses E and F).

Figure 23   Configuring Multiple IPsec VPN Connections Sharing an Inner Address

When configuring multiple IPsec VPN connections sharing an inner address, each VPN

connection is configured like Configuration B or C. However, the following differences

apply:

- There is only one inner Router MO and one RouteTableIPv4Static or RouteTableIPv6Static MO.
- In this example, the AddressIPv4 or the AddressIPv6 MO is configured for the local inner address as a child to a separate loopback InterfaceIPv4 or InterfaceIPv6 MO in the inner Router MO. With this configuration, the address is always set to ENABLED.
- A specific address or network is configured as dst in each Dst MO instead of default address. The destinations must be different.

In the configuration shown in Figure 23, the local

inner address is shared by all IPsec VPN connections in the inner

Router MO. The local inner address is sent as the local traffic

selector into the negotiation with the Security Gateways.

Figure 24 shows a configuration with multiple

IPsec VPN connections sharing the same inner address. The inner address is allocated

using IKEv2 Configuration Payload. In this case, the AddressIPv4 or

AddressIPv6 MO for the local inner address must be a child to one

of the tunnel InterfaceIPv4 or InterfaceIPv6

MOs.

Figure 24   Configuration When Using IKEv2 Configuration Payload

In IPsec VPN connection 1, the address MO is configured. In the configuration shown in

Figure 24, IPsec VPN connection 1 is

established first, and it gets an allocated address. After that, the other IPsec VPN

connections in the inner Router MO are established with the address

allocated for IPsec VPN connection 1. The first Security Gateway must support IKEv2

Configuration Payload. The second Security Gateway must be configured for manual

mode.

In the previous examples, the AddressIPv4 or

AddressIPv6 MO for the local outer address and the

PeerIPv4 or PeerIPv6 MO belong to the same

outer Router MO.

It is possible to use different local outer addresses in different outer

Router MOs. Different IP versions can be applied in the outer

network for the different IPsec VPN connections.

In ECT, loopback interfaces can be created inside the inner Router.

### 2.6.5 IPsec Connection Redundancy

It is possible to configure IPsec with redundancy towards two (or more) security

gateways, one primary and one (or more) secondary gateways.

Figure 25   IPsec VPN Connection Redundancy

The following IP addresses are applied:

- A: Local outer address. The address of the RBS in the outer (untrusted) network. If two VPN connections are configured, different addresses can be applied.
- B: Remote outer address for the primary connection. The address to the primary SEG.
- C: Remote outer address for the secondary connection. The address to the secondary SEG.
- D: Local inner address. The address of the RBS in the inner (trusted) network.

IPsec redundancy can be configured in the following ways:

- Configuring two IPsec VPN connections in the same inner network to the different security gateways (active-active redundancy).
- Configuring one IPsec VPN connection with alternative security gateways (active-standby redundancy).
- Configuring the security gateway address with FQDN resolved into multiple IP addresses (security gateways) in the DNS server.

IPsec redundancy can be applied in the following configurations:

- Any of the typical IPsec configurations (Configuration A, B and C)
- Additional IPsec configurations (described earlier)

The Multiple IP Addresses for Security Gateway Resilience feature provides a different

kind of active-active IPsec redundancy with two local inner addresses. Multiple local

inner addresses in the same VR can be configured for separate IPsec VPN connections

using PBR. For more information, see Multiple IP Addresses for Security Gateway Resilience.

In ECT, if inner addresses are to be defined only on loopback interfaces (active-active

redundancy), the loopback addresses only slider should be selected in the local inner

address definition field for the corresponding IPsec Interfaces. Peer IP address can be

provided in CIQ either as an IP address or as FQDN.

Related Information

Configuration A

Configuration B

Configuration C

Configuring Outer Addresses using DHCP, DHCPv6, SLAAC, and FQDN

Configuring Active-Active Redundancy

Configuring Active-Standby Redundancy

#### 2.6.5.1 Configuring Active-Active Redundancy

With the active-active redundancy, two (or more) IPsec VPN connections are established,

one to each Security Gateway. Traffic from the node is sent through one of the following

IPsec VPN connections:

- Through the primary connection, if the connection is up
- Through the secondary connection, if the primary connection is down

For downlink traffic, the switch from the primary IPsec VPN connection to the secondary

IPsec VPN connection is handled by the Security Gateways and routers in the trusted

network behind the Security Gateways. The node can receive downlink traffic through both

the primary and secondary VPN connection.

Figure 26   Configuring Active-Active Redundancy

To achieve redundancy, two (or more) IPsec VPN connections are configured in the same

inner Router MO.

The primary IPsec VPN connection is configured as described in any of the type

configurations (A, B, and C) with one exception. The inner

InterfaceIPv4 or InterfaceIPv6 MO does not

have any AddressIPv4 or AddressIPv6 MO as a

child.

The secondary IPsec VPN connection is configured as described in Table 16.

Table 16   Secondary IPsec VPN Connection Configuration

| MO                                                             | Configuration                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|----------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| PeerIPv4 or PeerIPv6 (C)                                       | Created under the same outer Router MO as the                                     AddressIPv4 or AddressIPv6                                 (A) MO.   PeerIPv4.address attribute or                                     PeerIPv6.address attribute = the outer                                 address of the secondary Security Gateway.                                                                                                                                                                                                                                                                                                                                                     |
| IpsecTunnel                                                    | Created under the same inner Router MO as the                                     IpsecTunnel MO for the primary                                 connection.  IpsecTunnel.localAddress attribute = reference to                                 the AddressIPv4 or AddressIPv6                                 (A) MO created in the outer Router MO.  IpsecTunnel.remoteAddress attribute = reference to                                 the PeerIPv4 or PeerIPv6 (C)                                 MO for the secondary connection.                                                                                                                                                        |
| Ikev2Session                                                   | Ikev2Session.ikev2PolicyProfile attribute =                                 reference to the same Ikev2PolicyProfile MO as                                 the one used for the primary connection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| IpsecPolicy                                                    | Configured identically to the IpsecPolicy MO for                                 the primary connection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| InterfaceIPv4 or                                 InterfaceIPv6 | Tunnel interface for the secondary connection under the inner                                     Router MO.  InterfaceIPv4.encapsulation attribute = reference                                 to the IpsecTunnel MO for the secondary                                 connection.  InterfaceIPv6.encapsulation attribute = reference                                 to the IpsecTunnel MO for the secondary                                 connection.  Besides the encapsulation, the configuration is identical to                                     InterfaceIPv4 or                                     InterfaceIPv6 MO for the primary                                 connection. |
| NextHop                                                        | Created under the same Dst MO as the                                     NextHop for the primary connection.  NextHop.reference attribute = reference to the                                 tunnel InterfaceIPv4 or                                     InterfaceIPv6 MO for the secondary                                 connection.  NextHop.adminDistance = higher value than the                                     NextHop.adminDistance attribute for the                                 primary connection.                                                                                                                                                                         |

The local inner address is shared by both IPsec VPN connections. The

AddressIPv4 or AddressIPv6 MO for the local

inner address is configured as a child to a separate loopback

InterfaceIPv4 or InterfaceIPv6 MO in the inner

Router MO. In this way, the address is always enabled. If the

address is configured as a child to the primary tunnel InterfaceIPv4

or InterfaceIPv6 MO, it is disabled when the primary IPsec VPN

connection is down.

The AddressIPv4 or AddressIPv6 MO for the local

outer address and both PeerIPv4 or PeerIPv6 MOs

belong to the same outer Router MO. Both

IpsecTunnel MOs refer to the same local outer address

AddressIPv4 or AddressIPv6 MO. It is however

possible to use different local outer address AddressIPv4 or

AddressIPv6 MOs (using different TN ports).  In this way, link

redundancy can be achieved.

The traffic is routed through the different IPsec VPN connections, based on normal static

routing. Traffic is routed through the primary IPsec VPN connection as long as it is up.

The primary IPsec VPN connection is provided by the NextHop MO with

the lowest administrative distance. The detection of failover from the primary IPsec VPN

connection depends on the Ikev2PolicyProfile.dpdTime attribute.

Failback waiting time depends on the

InterfaceIPv4.routesHoldDownTimer or

InterfaceIPv6.routesHoldDownTimer attribute for the primary IPsec

VPN connection.

If there are more secondary IPsec VPN connections, the

NextHop.adminDistance attribute defines the priority between the

secondary VPN connections. The priority must be different for each secondary VPN

connection.

The local inner address cannot be allocated dynamically using the IKEv2 configuration

payload when redundant IPsec VPN connections are configured.

It is possible to configure a mix of IPv4 and IPv6 in the redundant IPsec VPN

connections. In such cases, the IPv4 and the IPv6 traffic can be sent through different

IPsec VPN connections. For example, if the primary Security Gateway is not configured

for IPv6, the IPv4 traffic is still sent through the primary IPsec VPN connection.

However, in this case, IPv6 is sent through the secondary IPsec VPN connection.

Related Information

Configuration A

Configuration B

Configuration C

#### 2.6.5.2 Configuring Active-Standby Redundancy

In active-standby redundancy, one IPsec VPN connection is established towards one of the

Security Gateways. The other Security Gateway is in standby mode. If possible, the IPsec

VPN connection is established towards the primary Security Gateway. This setup can be

useful if one secondary Security Gateway is used for several primary Security

Gateways.

Figure 27   Configuring Active-Standby Redundancy

The IPsec VPN connection configuration can be type A, B, or C. To achieve redundancy, the

following configuration is required:

- A second PeerIPv4 or PeerIPv6 MO is configured in the outer Router for the secondary Security Gateway.
- The IpsecTunnel.remoteAddressSecondary attribute is set for the second PeerIPv4 or PeerIPv6 MO.

The negotiation to set up the IPsec VPN connection is always started towards the primary

Security Gateway. If the IPsec VPN connection cannot be established with the primary

Security Gateway, negotiation is started with the secondary Security Gateway.

Once the IPsec VPN connection is established to one of the Security Gateways, failure of

the active Security Gateway is detected based on the Ikev2PolicyProfile.dpdTime attribute.

When the primary Security Gateway is failing, the switch to the secondary security is

delayed by the negotiation attempt towards the primary Security Gateway.

Switching back does not take place automatically when the primary Security Gateway

becomes available. Switching back occurs only when the secondary Security Gateway fails.

It is also possible to trigger a switch back by using the action

Ikev2Session.restartIkeSa.

It is possible to set which Security Gateway is to be primary and which is to be

secondary. To do so, the IpsecTunnel.remoteAddress and the IpsecTunnel.remoteAddressSecondary attributes must be changed.

Unlike the case with two redundant IPsec VPN connections, the local inner address can be

dynamically allocated using IKEv2 configuration payload. However, active-standby

redundancy cannot be combined with configuring Security Gateway address as FQDN.

If a mix of IPv4 and IPv6 traffic is configured in the IPsec VPN connection, the IPv4 and

IPv6 traffic cannot be sent to different Security Gateways. For example, if the primary

Security Gateway is not configured for IPv6, the IPsec VPN connection is still

established to the primary Security Gateway and IPv4 traffic can be sent. No IPv6

traffic can be sent through the IPsec VPN connection in this case.

Related Information

Configuration A

Configuration B

Configuration C

#### 2.6.5.3 Migrate No Redundancy to Active-Active Redundancy

To migrate from an IPsec configuration without redundancy to an IPsec configuration

with

two

redundant IPsec VPN connections, the following

steps

are needed before the secondary IPsec VPN connection is configured:

Steps

1. Delete the NextHop MO referring to the tunnel InterfaceIPv4 or InterfaceIPv6 MO.
2. Change the tunnel InterfaceIPv4 or InterfaceIPv6 MO to a loopback InterfaceIPv4 or InterfaceIPv6 MO. That is, reset InterfaceIPv4.encapsulation or InterfaceIPv6.encapsulation and set InterfaceIPv4.loopback or InterfaceIPv6.loopback.
3. Create a new tunnel InterfaceIPv4 or InterfaceIPv6 MO (without AddressIPv4 or AddressIPv6 MO as child) for the primary IPsec VPN connection.
4. Create the NextHop MO again with reference to the new tunnel InterfaceIPv4 or InterfaceIPv6 MO.

## 2.7 Direct IPsec for X2 and Xn

### 2.7.1 Direct IPsec for X2 in eNodeB

In the typical IPsec configurations (Configuration A, B, and C), the S1, and X2 traffic

is sent on the same IPsec VPN connection. Therefore, the X2 traffic is typically routed

through a centrally placed Security Gateway, as shown in Figure 28.

Figure 28   X2 Traffic through a Centrally Placed Security Gateway

When using functionality like inter-eNodeB carrier aggregation, the delay constraint on

the LTE X2 traffic can be stringent. The delay budget cannot be met if the LTE X2

traffic is routed through a centrally placed Security Gateway. However, direct IPsec VPN

connections can be set up between neighboring eNodeBs for LTE X2. The LTE X2 traffic is

directed to the shortest route between the eNodeBs when IPsec is used.

In an NR-NSA deployment (EN-DC case), EN-DC X2 traffic between eNodeB and gNodeB have

similar delay constraint. Direct IPsec VPN connections can be established between

eNodeBs and gNodeBs for EN-DC X2.

Figure 29   X2 Traffic between eNodeB and gNodeB

Before the eNodeB can set up direct IPsec VPN connections, a configured IPsec VPN

connection for S1 and X2 to a Security Gateway must exist for the following reasons:

- S1 is needed to exchange neighbor addresses between eNodeBs.
- X2-C is needed as direct IPsec VPN connection is established after the X2-C connection is set up.
- X2-U is needed in case direct IPsec VPN connection cannot be established with a neighbor node.

Direct

IPsec is enabled by configuring the local outer IP address (the IPsec endpoint) to be

used.

Different PLMNs can be configured with different local IPsec endpoints and direct IPsec

can be enabled for different PLMNs individually. Between two shared nodes direct IPsec

VPN connection is established for the primary PLMN. If the two shared nodes have

different primary PLMNs, direct IPsec VPN connection is established for the primary PLMN

of one of the nodes.

For LTE X2, dual-stack configuration can be applied for the primary PLMN. It is possible

to configure one IPv4 and one IPv6 local IPsec endpoint for LTE X2. If both are

configured, one is selected for each LTE X2 neighbor, IPv6 is preferred.

One of the local IPsec endpoints for LTE X2 for the primary PLMN can be reused for EN-DC

X2, or a separate local IPsec endpoint can be configured for EN-DC X2. Because of this,

it is possible to enable

direct

IPsec for EN-DC X2 but not for LTE X2. Different IP versions can be used.

For other PLMNs, the local IPsec endpoints for LTE X2 and EN-DC X2 are configured

independently.

Different PLMNs can be configured with different X2-U addresses. Between two shared

nodes, the direct IPsec VPN connection is established for the primary PLMN. X2 traffic

for other PLMNs using different X2 addresses is sent through the SEG.

For the primary PLMN, one IPv4 and one IPv6 inner address can be configured for LTE X2.

If both are configured, one is selected for each LTE X2 neighbor, IPv6 is preferred. One

of the inner addresses can be reused for EN-DC X2, or a separate inner IP address can be

configured for EN-DC X2.

For details about the selection of local X2-U address and IPsec endpoints in the case of

configuring separate addresses for different PLMNs, see Multiple IP Addresses for S1 and X2.

It is possible to use separate IP addresses for S1 and X2, as well as user plane and

control plane. The address for the X2-U is used as the inner address in the

direct

IPsec VPN connection. The reason is that the delay constraint is relevant for user plane

traffic.

X2-C traffic is sent through the

direct

IPsec VPN connection once it is set up, but only if the same address is used for X2-U

and X2-C.

Direct

IPsec VPN connections cannot be used in any of the following cases:

- The neighbor node is not from Ericsson.
- Either node is behind a NAT device.
- For LTE X2, if the Configuration Transfer procedure is not supported in the MME, or the MME is not configured properly.
- The eNodeB is configured with cell-defined primary PLMN ID. For more information, see Shared LTE RAN.

For LTE X2, the IPsec endpoints and the X2-U addresses are exchanged between the eNodeBs

using the MME Configuration Transfer procedure in S1-AP.

For EN-DC X2, the IPsec endpoints and the X2-U addresses

are exchanged between the eNodeB and the gNodeB using the EN-DC Configuration Transfer

in X2-AP. This is done after the X2-C connection is established.

Once direct

IPsec is enabled and the X2-C connection is established, the nodes automatically set up

a direct

IPsec VPN connection based on the exchanged IP addresses.

The possible number of LTE X2 neighbors is 512 and the possible number of EN-DC X2

neighbors is 256.

If direct

IPsec is enabled, there can be one

direct

IPsec VPN connection to each LTE X2 neighbor (eNodeB) and one to each EN-DC X2 neighbor

(gNodeB).

The total number of

direct

IPsec VPN connections is 512. When the 512

direct

IPsec VPN connections are established, X2 traffic to other neighbors is sent through the

Security Gateway.

If the total number of LTE X2 and EN-DC X2 neighbors

is expected to

exceed

512, it is recommended to enable

direct

IPsec for EN-DC X2 only and not for LTE X2. This way EN-DC X2 traffic is always sent

with low latency.

Configuration of

Direct

IPsec VPN Connections

The typical IPsec configuration (Configuration A) is extended to support the setup of

the

direct

IPsec VPN connections, as shown in Figure 30.

Figure 30   Configuration for

Direct

IPsec VPN Connections

In the extended configuration, the following steps need to be performed:

1. When setting up a configured IPsec VPN connection to the Security Gateway, the node must validate the node certificate of the Security Gateway. The TrustCategory MO used by IPsec must refer to a TrustedCertificate MO holding the CA certificate used to sign the node certificate of the Security Gateway. For a direct IPsec VPN connection, the node must validate the node certificate of the neighbor eNodeB or gNodeB. The configuration must be extended with a TrustedCertificate MO holding the CA certificate that is used to sign the node certificate of the neighbor node. Usually, the same CA certificate is used to sign the node certificate of the node and all neighboring eNodeBs and gNodeBs. It is possible to include the additional TrustedCertificate MO in the existing TrustCategory MO, but it is recommended to use a separate TrustCategory MO for direct IPsec. The advantage of using different TrustCategory MOs with different TrustedCertificate MOs is increased security in the following aspects: The configured IPsec VPN connection to the Security Gateway is established only if the peer certificate is signed by the CA of the Security Gateway. The direct IPsec VPN connection is established only if the peer certificate is signed by the CA of the eNodeB or gNodeB. It is also possible to activate certificate revocation for direct IPsec VPN connections even if it is not activated for configured IPsec VPN connections to SEGs.
2. An Ikev2PolicyProfile MO and an IpsecProposalProfile MO must be configured to define the properties for direct IPsec. The same MOs as those used for the configured IPsec VPN connection to the Security Gateway can be used. It is however recommended to use separate MOs to be able to define different properties for direct IPsec. The following restrictions and mandatory configurations must be considered for direct IPsec: For direct IPsec VPN connections, pre-shared key is not supported therefore certificate-based authentication must be used. Both Ikev2PolicyProfile.credential and Ikev2PolicyProfile.trustCategory attributes must be set. To be able to use a separate TrustCategory MO for direct IPsec, a separate Ikev2PolicyProfile MO must be configured. The dataLimit parameter in the IpsecProposalProfile.childSaLifetime attribute must be nil, and the IpsecProposalProfile.pfs attribute must be FALSE. It is recommended to use the same setting for the Ikev2PolicyProfile.dpdTime attribute as for the corresponding attribute for the IPsec VPN connection to the SEG. With different settings there may be traffic disturbance when direct IPsec VPN connection is established and released. Note: It is not recommended to configure group 14 or 2 for the DiffieHellmanGroup parameter in the Ikev2PolicyProfile.ikev2Proposal attribute. With this configuration, traffic can be disturbed during setup, or IKE SA rekeying for direct IPsec VPN connections can occur. Default configuration for both Ikev2PolicyProfile and IpsecProposalProfile MOs can be used.
3. A PeerIpsecProfile is created under the Router MO where the X2-U address is configured. The PeerIpsecProfile MO defines common properties that are used for the direct IPsec VPN connections, by referring to the Ikev2PolicyProfile MO and the IpsecProposalProfile MO. If different X2-U addresses are used and the addresses are configured in different inner Router MOs, a PeerIpsecProfile MO must be configured in each inner Router MO.
4. Direct IPsec for LTE and EN-DC X2 is enabled by setting the ENodeBFunction.ipsecEpAddressRef attribute. It configures the local IPsec endpoint to use for the direct IPsec VPN connections. Normally this refers to the same outer AddressIPv4 or AddressIPv6 as used by the configured IPsec VPN connection to the Security Gateway. It is however possible to select a different AddressIPv4 or AddressIPv6. For LTE X2 dual-stack, the local IPsec endpoint of the other IP version is configured using the ENodeBFunction.ipsecEpAddress2Ref attribute. A separate local IPsec endpoint can be configured for EN-DC X2 by using the ENodeBFunction.ipsecEndcEpAddressRef attribute. Different IP versions can be used. If ENodeBFunction.ipsecEndcEpAddressRef is set but not ENodeBFunction.ipsecEpAddressRef, direct IPsec is enabled for EN-DC X2 but not for LTE X2. The X2-U address for LTE X2 is configured in different attributes in the following scenarios: When S1-U and X2-U share same IP address, the IP address is configured in the EnodeBFunction.upIpAddressRef attribute. When S1-U and X2-U use separate IP addresses, the X2-U address for LTE X2 is configured in the EnodeBFunction.upX2IpAddressRef attribute. For LTE X2 dual-stack, the ENodeBFunction.upX2IpAddress2Ref attribute is also used. A separate X2-U address for EN-DC X2 can be configured with the ENodeBFunction.upEndcX2IpAddressRef attribute. If this attribute is not set, the X2-U address configured for LTE X2 is used for EN-DC X2. In a shared eNodeB with separate addresses for different PLMNs, the X2-U address and IPsec endpoint are configured in different MOs for primary PLMN and the additional PLMNs. For primary PLMN, the X2-U address and IPsec endpoint are configured in the ENodeBFunction MO. For the additional PLMNs, the X2-U address and IPsec endpoint are configured in the following AdditionalCoreNetwork MO attributes: AdditionalCoreNetwork.upX2IpAddressRef attribute and AdditionalCoreNetwork.ipsecEpAddressRef attribute for LTE X2. AdditionalCoreNetwork.upX2EndcIpAddressRef attribute and AdditionalCoreNetwork.ipsecEndcEpAddressRef attribute for EN-DC X2. The IP reference selection is based on the PLMN of the X2 neighbor node. For details, see Multiple IP Addresses for S1 and X2.
5. The ENodeBFunction.x2IpAddrViaS1Active attribute must be set to TRUE if direct IPsec is enabled for LTE X2. Then, the X2 addresses and IPsec endpoints can be exchanged between eNodeBs using the MME Configuration Transfer procedure in S1-AP.
6. If the neighbor gNodeB does not support automatic direct IPsec, that is, the gNodeB is still running on an older software version, the TermPointToGNB.ipsecEpAddress attribute must be manually configured. If different X2-U and X2-C addresses are used in this case, the TermPointToGNB.upIpAddress attribute must also be configured.Note: If the neighbor gNodeB supports automatic direct IPsec, any configuration of the TermPointToGNB.ipsecEpAddress or TermPointToGNB.upIpAddress attribute is irrelevant.

Direct

IPsec VPN connections are set up to relevant neighbor eNodeBs and gNodeBs after the

X2-C connection is established with the neighbor. The X2-C connection is established

through the Security Gateway.

If

direct

IPsec is enabled for LTE X2 in the node for the relevant PLMN, the node proceeds as

follows:

- The X2-U addresses and IPsec endpoints are exchanged between the neighbor eNodeBs with the MME Configuration Transfer Procedure in S1-AP. If no response is received from the neighbor node, direct IPsec VPN connection is not set up.
- If the neighbor node is from Ericsson and an IPsec endpoint is received, the IPsec endpoint is set in the TermPointToENB.ipsecEpAddress attribute, and a PeerIpsecTunnel MO is created. The PeerIpsecTunnel MO represents the direct IPsec VPN connection to this specific neighbor eNodeB. Two X2-U addresses and IPsec endpoints of different IP version can be received from a neighbor with LTE X2 dual-stack configuration. The IP version matching the local configuration is selected independently for each. If there is local dual-stack configuration, IPv6 is preferred.

If

direct

IPsec is enabled for EN-DC X2 in the node for the relevant PLMN, and the neighbor

gNodeB is an Ericsson node that supports automatic direct IPsec, the node proceeds

as follows:

- X2-U addresses and IPsec endpoints are exchanged between the neighbor eNodeB and gNodeB with the EN-DC Configuration Transfer procedure in X2-AP. Any configuration of the TermPointToGNB.ipsecEpAddress or the TermPointToGNB.upIpAddress attribute is ignored.
- If an IPsec endpoint is received from the neighbor gNodeB, a PeerIpsecTunnel MO is created, which represents the direct IPsec VPN connection to this specific neighbor gNodeB.

If the TermPointToENB or TermPointToGNB MO is

disabled, or locked, the node releases the

direct

IPsec VPN connection to the specific neighbor and the

PeerIpsecTunnel MO is removed. When the

TermPointToENB or TermPointToGNB is

enabled, or unlocked, the X2-C connection is established again and then

direct

IPsec VPN connection is created.

The PeerIpsecTunnel MOs are created under the same Router MO as

the AddressIPv4 or AddressIPv6 MO used as the

local inner X2-U address. If the PeerIpsecProfile MO is not

created, the PeerIpsecTunnel MO is still created, but it remains

DISABLED and no

direct

IPsec VPN connection is established. If different X2-U addresses are used for LTE X2

and EN-DC X2, or for different PLMNs, different Router and

PeerIpsecProfile MOs can be used.

Parameter Settings with the ECT

In ECT, Direct IPsec is enabled in eNodeB for EN-DC X2 by setting LTE Radio Access

Settings/Direct IPsec slider to enabled. See Table 17 and Table 18 for parameter settings.

Table 17   Router Settings

| Parameter          | Value Instance 1                                      | Value Instance 2   |
|--------------------|-------------------------------------------------------|--------------------|
| Router identity    | MyOuter                                               | MyInner            |
| Interface identity | 1                                                     | 1                  |
| Interface type     | Physical interface                                    | Ipsec interface    |
| Physical connector | TN_A (or other port applicable for selected hardware) | N/A                |
| VLAN usage         | Disabled or Enabled                                   | N/A                |
| Used outer router  | N/A                                                   | MyOuter            |
| IP version         | IPv4 or IPv6                                          | IPv4 or IPv6       |

Table 18   LTE Radio Access Settings

| Parameter    | Value   |
|--------------|---------|
| Used router  | MyInner |
| Direct IPsec | Enabled |

To enable Direct IPsec for LTE X2 as well, the LTE Radio Access Settings/Direct X2

outer address must also be set. See Table 19 and Table 20 for parameter

settings.

Table 19   Router Settings

| Parameter          | Value Instance 1                                      | Value Instance 2   |
|--------------------|-------------------------------------------------------|--------------------|
| Router identity    | MyOuter                                               | MyInner            |
| Interface identity | 1                                                     | 1                  |
| Interface type     | Physical interface                                    | Ipsec interface    |
| Physical connector | TN_A (or other port applicable for selected hardware) | N/A                |
| VLAN usage         | Disabled or Enabled                                   | N/A                |
| Used outer router  | N/A                                                   | MyOuter            |
| IP version         | IPv4 or IPv6                                          | IPv4 or IPv6       |

Table 20   LTE Radio Access Settings

| Parameter               | Value   |
|-------------------------|---------|
| Used router             | MyInner |
| Direct IPsec            | Enabled |
| Direct X2 outer address | MyOuter |

To configure a specific outer address for Direct IPsec for LTE X2 or EN-DC X2, Direct

X2 outer address or Direct ENDC outer address is set in LTE Radio Access Settings.

Table 21 shows how to enable Direct

IPsec for EN-DC X2 only, using a separate outer address. Note that the separate

outer address must be configured in the MyOuter Router as well.

Table 21   LTE Radio Access Settings with Direct ENDC

| Parameter                 | Value          |
|---------------------------|----------------|
| Used router               | MyInner        |
| Direct IPsec              | Enabled        |
| Direct ENDC outer address | MyOuter/1/ENDC |

Related Information

Configuration A

Configuration B

Configuration C

### 2.7.2 Direct IPsec for X2 and Xn in gNodeB

In an EN-DC deployment, the delay constraint on the X2 traffic between eNodeB and gNodeB

can be strict. The delay budget cannot be always met, if the X2 traffic is routed

through a centrally placed SEG. Direct IPsec VPN connections can be set up between

eNodeB and gNodeB and the X2 traffic is directed to the shortest route even when IPsec

is used, as shown in Figure 31.

In an NR-DC deployment, the same delay constraint applies to Xn traffic and the direct

IPsec VPN connections can be set up for Xn between gNodeBs to meet the delay budget. See

Figure 31.

Figure 31   Direct IPsec VPN Connections for X2 and Xn in gNodeB

Before the direct IPsec VPN connections can be set up, there must be a configured IPsec

VPN connection to a SEG for S1, NG, X2, and Xn. The reasons are the following:

- X2-C is needed as the direct IPsec VPN connection for X2 is established after the X2-C connection is set up.
- Xn-C is needed as the direct IPsec VPN connection for Xn is established after the Xn-C connection is set up.
- X2-U and Xn-U are needed in case direct IPsec VPN connection cannot be established with all neighbor nodes.

The typical configurations (Configuration A, B, and C) can be used to meet this

requirement.

Direct IPsec is enabled by configuring the local outer IP address (the IPsec endpoint) to

be used.

Direct IPsec can be enabled individually for X2

and Xn for each PLMN. Different local IPsec endpoints, local X2-U and Xn-U addresses can

be configured for each PLMN.

It is possible to use separate IP addresses for S1, X2, NG, and Xn. It is also possible

to used separate IP addresses for user plane and control plane. The delay constraint is

relevant for user plane traffic. Thus, the X2-U address is used as an inner IP address

for direct IPsec for X2 and the Xn-U address is used as an inner IP address for direct

IPsec for Xn.

If the same address is used for X2-C and X2-U, the X2-C traffic is sent through the

direct IPsec VPN connection once it is set up. If different inner addresses are used for

X2-U and X2-C traffic, the X2-C traffic is still sent through the SEG. The same applies

to Xn-C traffic.

Direct IPsec VPN connections cannot be used in any of the following cases:

- The neighbor node is not from Ericsson
- Either node is behind a NAT device
- gNodeBs are not upgraded to the software version supporting the direct IPsec
- Different Xn-U IP addresses are set for different slices

For EN-DC X2, the IPsec endpoints and the X2-U addresses are exchanged between the eNodeB

and the gNodeB using the EN-DC Configuration Transfer procedure in X2-AP after the X2-C

connection is established. Once direct IPsec is enabled and the X2-C connection is

established, the nodes automatically set up the direct IPsec VPN connection for X2 based

on the exchanged IP addresses and the primary PLMN of the eNodeB.

For Xn, the IPsec endpoints and the Xn-U addresses are exchanged between the gNodeBs

using the Xn Configuration Transfer procedure in Xn-AP after the Xn-C connection is

established. Once direct IPsec is enabled and the Xn-C connection is established, the

nodes automatically set up the direct IPsec VPN connection for Xn based on the exchanged

IP addresses and the primary PLMN of the gNodeBs.

The maximum possible number of EN-DC X2 neighbors is 256 and the maximum possible number

of Xn connections is 512.

If direct IPsec is enabled, there can be one direct IPsec VPN connection to each EN-DC X2

neighbor, and one to each Xn neighbor.

The total number of direct IPsec VPN connections is 512. When all 512 direct IPsec VPN

connections are established, X2 and Xn traffic to other neighbors is sent via the

SEG.

If the total number of EN-DC X2 and Xn neighbors is expected to exceed 512, it is recommended to enable direct IPsec for Xn only when NR-DC is used. If direct IPsec is enabled for EN-DC X2 only, all EN-DC X2 traffic can be sent with low latency.

Configuration of Direct IPsec VPN Connections

The typical IPsec configuration

(Configuration A) is extended to support setup of direct IPsec VPN connections, as

shown in Figure 32.

Figure 32   Configuration of Direct IPsec VPN Connections

In the extended configuration, the following steps need to be performed:

1. When setting up a configured IPsec VPN connection to the SEG, the node must validate the node certificate of the SEG. The TrustCategory MO used by IPsec must refer to a TrustedCertificate MO holding the CA certificate used to sign the node certificate of the SEG. For a direct IPsec VPN connection, the node must validate the node certificate of the neighbor eNodeB or a gNodeB. The configuration must be extended with a TrustedCertificate MO holding the CA certificate that is used to sign the node certificate of the neighbor node. Usually, the same CA certificate is used to sign the node certificate of all neighboring eNodeBs and gNodeBs, including the own node certificate. It is possible to include the additional TrustedCertificate MO in the existing TrustCategory MO, but it is recommended to use a separate TrustCategory MO for direct IPsec. The advantage of using different TrustedCertificate MOs with different TrustCertificate MOs is increased security in the following aspects: The configured IPsec VPN connection to the SEG is established only if the peer certificate is signed by the CA of the SEG. The direct IPsec VPN connection is established only if the peer certificate is signed by the CA of the eNodeB or gNodeB. It is also possible to activate certificate revocation for direct IPsec VPN connections even if it is not activated for configured IPsec VPN connections to SEGs.
2. An Ikev2PolicyProfile MO and an IpsecProposalProfile MO must be configured to define the properties for direct IPsec. The same MOs as the ones used for the configured IPsec VPN connections to the SEG can be used. It is however recommended to use separate MOs to be able to define different properties for direct IPsec. The following restrictions and mandatory configurations must be considered for direct IPsec: For direct IPsec VPN connections, pre-shared key is not supported therefore certificate-based authentication must be used. Both Ikev2PolicyProfile.credential and Ikev2PolicyProfile.trustCategory attributes must be set. To be able to use a separate TrustCategory MO for direct IPsec, a separate Ikev2PolicyProfile MO must be configured. The dataLimit parameter in the IpsecProposalProfile.childSaLifetime attribute must be nil, and the IpsecProposalProfile.pfs attribute must be FALSE. It is recommended to use the same setting for the Ikev2PolicyProfile.dpdTime attribute as for the corresponding attribute for the IPsec VPN connection to the SEG. With different settings, there might be traffic disturbance when direct IPsec VPN connection is established and released. Note: It is not recommended to configure group 14 or 2 for the DiffieHellmanGroup parameter in the Ikev2PolicyProfile.ikev2Proposal attribute. With this configuration, traffic can be disturbed during setup, or IKE SA re-keying for direct IPsec VPN connections can occur. Default configuration for both Ikev2PolicyProfile and IpsecProposalProfile MOs can be used.
3. A PeerIpsecProfile is created under the Router MO where the X2-U and Xn-U addresses are configured. The PeerIpsecProfile MO defines common properties that are used for the direct IPsec VPN connections, by referring to the Ikev2PolicyProfile MO and the IpsecProposalProfile MO. If different X2-U and Xn-U addresses are used or different addresses are configured for different PLMNs, the X2-U and Xn-U addresses can be configured in different Router MOs. In this case, a PeerIpsecProfile MO must be configured in each Router MO.
4. The X2-U address is configured in the LocalIpEndpoint.addressRef attribute when the LocalIpEndpoint.interfaceList attribute includes X2. The Xn-U address is configured in the LocalIpEndpoint.addressRef attribute when the LocalIpEndpoint.interfaceList attribute includes Xn. In the default EndpointResource MO, both X2 and Xn are included. If the same IP address is used for both X2-U and Xn-U, one LocalIpEndpoint MO can be used. If different EndpointResource MOs are configured for different PLMNs, different X2-U and Xn-U addresses can be defined for each PLMN. If the PLMN is included in a ResourcePartitionMember MO, different ResourcePartitionMember MOs and EndpointResource MOs must be configured for X2 and Xn. If there is no LocalIpEndpoint MO configured for X2 for the primary PLMN of the eNodeB, the LocalIpEndpoint MO configured for X2 in the default EndpointResource MO is used. If there is no LocalIpEndpoint MO configured for Xn for the selected PLMN, the LocalIpEndpoint MO for Xn in the default EndpointResource MO is used. The selected PLMN is the primary PLMN of the node or the neighbor gNodeB.
5. Direct IPsec is enabled by creating a LocalIPsecEndpoint MO in the same EndpointResource MO as the relevant LocalIpEndpoint MO. The LocalIPsecEndpoint.interfaceList attribute includes the relevant interface, which can be X2, Xn, or both. The LocalIPsecEndpoint.outerIpAddressRef attribute refers to the local outer IP address to be used. In the default EndpointResource MO, one LocalIPsecEndpoint MO can be used to enable the direct IPsec for both X2 and Xn if the same local outer IP address is used. Normally, the local outer IP address for the direct IPsec is the same as the one used by the configured IPsec VPN connection to the SEG. It is also possible to select a different AddressIPv4 or AddressIPv6 MO. If different EndpointResource MOs are configured for different PLMNs, direct IPsec can be enabled for each PLMN individually.
6. To use the direct IPsec VPN connections for NR-DC traffic, the following MOs must refer to the same AddressIPv4 or AddressIPv6 MO: The LocalIpEndpoint MO in the GNBDUFunction MO for F1 interface The LocalIpEndpoint MO in the GNBCUUPFunction MO for Xn interface
7. If the neighbor eNodeB does not support automatic direct IPsec, that is, it is still running on an earlier software version, and different X2-U and X2-C addresses are used, the TermPointToENodeB.upIpAddress attribute must be configured. If different X2-U addresses are used for different PLMNs, the TermPointToENodeB.ipsecEpAddress attribute must be configured. Note: If the neighbor eNodeB supports automatic direct IPsec, any configuration of the TermPointToENodeB.ipsecEpAddress or the TermPointToENodeB.upIpAddress attribute is irrelevant.

Direct IPsec VPN connections are set up to relevant neighbor nodes after the X2-C or

Xn-C connection is established with the neighbor. The X2-C and Xn-C connections are

established through the SEG.

If direct IPsec is enabled for EN-DC X2 in the

node, the node proceeds as follows:

- When both nodes support automatic direct IPsec, the node waits for the eNodeB to initiate the EN-DC Configuration Transfer procedure over X2-AP to exchange IPsec endpoints and X2-U addresses. This is initiated if direct IPsec is enabled for EN-DC X2 in the eNodeB.
- If direct IPsec is enabled for EN-DC X2 for the primary PLMN of the eNodeB, a PeerIpsecTunnel MO is created using the received IP addresses. The PeerIpsecTunnel MO represents the direct IPsec VPN connection to the specific neighbor eNodeB. Note: If automatic direct IPsec is not supported by the eNodeB, no EN-DC Configuration Transfer is initiated by the eNodeB. The PeerIpsecTunnel MO is created without knowing the outer IP address of the eNodeB. If the X2-U address is configured on the TermPointToENodeB MO, this is used when creating the PeerIpsecTunnel MO. Otherwise, the received X2-C address is used.

If direct IPsec is enabled for Xn for the relevant PLMN, the node proceeds as

follows:

- Xn-U addresses and IPsec endpoints are exchanged between the gNodeBs using the Xn Configuration Transfer procedure in Xn-AP. The gNodeB with the lower gNodeBId initiates the procedure.
- If an IPsec endpoint is received from the neighbor gNodeB, the Xn-U address and IPsec endpoint are stored in the TermPointToGNodeB MO and a PeerIpsecTunnel MO is created. The PeerIpsecTunnel MO represents the direct IPsec VPN connection to this specific neighbor gNodeB.

If the TermPointToENodeB or TermPointToGNodeB

MO is disabled or locked, the node releases the direct IPsec VPN connection to that

specific neighbor and the PeerIpsecTunnel MO is removed.

When the TermPointToENodeB or TermPointToGNodeB

MO is enabled or unlocked, the X2-C or Xn-C connection is established again and then

the direct IPsec VPN connection.

The PeerIpsecTunnel MOs are created under the same

Router MO as the AddressIPv4 or

AddressIPv6 MO used as the X2-U or Xn-U address. The

PeerIpsecProfile MO must be created under the same

Router MO. If the

PeerIpsecProfile MO is not created, the

PeerIpsecTunnel MO is still created, but it remains

DISABLED and no direct IPsec VPN connection is

established.

If different X2-U and Xn-U addresses are used, or different addresses are configured

for different PLMNs, different Router and

PeerIpsecProfile MOs can be used.

Parameter Settings with the ECT

In ECT, Direct IPsec is enabled in gNodeB for both EN-DC X2 and Xn by setting NR

Radio Access Settings/Direct IPsec slider to enabled. See Table 22 and Table 23 for parameter settings.

Table 22   Router Settings

| Parameter          | Value Instance 1                                      | Value Instance 2   |
|--------------------|-------------------------------------------------------|--------------------|
| Router identity    | MyOuter                                               | MyInner            |
| Interface identity | 1                                                     | 1                  |
| Interface type     | Physical interface                                    | Ipsec interface    |
| Physical connector | TN_A (or other port applicable for selected hardware) | N/A                |
| VLAN usage         | Disabled or Enabled                                   | N/A                |
| Used outer router  | N/A                                                   | MyOuter            |
| IP version         | IPv4 or IPv6                                          | IPv4 or IPv6       |

Table 23   NR Radio Access Settings

| Parameter    | Value   |
|--------------|---------|
| Used router  | MyInner |
| Direct IPsec | Enabled |

To configure a specific outer address for Direct IPsec for EN-DC X2 or Xn, or enable

Direct IPsec for one interface only, Direct ENDC outer address or Direct Xn outer

address is set in NR Radio Access Settings. Table 24 shows how to enable Direct IPsec

for ENDC X2 but not for Xn.

Table 24   NR Radio Access Settings with Direct ENDC

| Parameter                 | Value   |
|---------------------------|---------|
| Used router               | MyInner |
| Direct IPsec              | Enabled |
| Direct ENDC outer address | MyOuter |

Related Information

Configuration A

Configuration B

Configuration C

Shared NR RAN

### 2.7.3 Direct IPsec in Mixed Mode Baseband Node with LTE and NR

The following X2

and Xn connections are possible in a mixed mode Baseband node with LTE

and NR:

- Internal EN-DC X2 between LTE and NR
- External EN-DC X2 between LTE in the node and NR in a mixed mode Baseband neighbor node or neighbor gNodeB
- External EN-DC X2 between NR in the node and LTE in a mixed mode Baseband neighbor node or neighbor eNodeB
- LTE X2 between LTE in the node and LTE in a mixed mode Baseband neighbor node or neighbor eNodeB
- Xn between NR in the node and NR in a mixed mode Baseband neighbor node or neighbor gNodeB

Each X2 and Xn

connection is established separately.

As a consequence, three separate X2 connections

and one Xn

connection are possible between two mixed mode Baseband neighbor

nodes. Two separate X2 connections are possible between a mixed mode Baseband node and a

neighbor eNodeB.

One X2 and one Xn connection are possible between a mixed mode Baseband node and a

neighbor gNodeB.

If the mixed mode Baseband node is deployed in an untrusted network, all X2

and Xn

traffic leaving the node must be protected by IPsec. If

direct

IPsec is required to reduce latency, each X2

and Xn

connection must have a separate

direct

IPsec VPN connection in some cases.

The pair of outer IP addresses must be unique for each IPsec VPN connection.

Shared Inner VR or Separate Inner VRs

LTE and NR in a mixed mode Baseband node can share the inner VR or can use separate

inner VRs. In both cases, internal EN-DC X2 traffic can be routed internally and

direct

IPsec is not relevant for internal EN-DC X2. Table 25 shows the relevant differences for

IPsec between shared and separate inner VRs.

Table 25   Shared VR or Separate VRs for LTE and NR

| Shared VR between LTE and NR                                                                                                                                                                                                                                                    | Separate VRs for LTE and NR                                                                                                                                                                                                              |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Internal EN-DC X2 traffic is routed internally in the VR.                                                                                                                                                                                                                       | Inter-VR route must be configured for the internal EN-DC X2                                     traffic.                                                                                                                                 |
| LTE and NR can share IPsec VPN connection to the security                                     gateway.                                                                                                                                                                          | LTE and NR must have separate IPsec VPN connections to the                                     security gateway.                                                                                                                         |
| The X2                                     and                                     Xn connections between two nodes can share a                                     single                                     direct                                     IPsec VPN connection. | Separate                                     direct                                     IPsec VPN connections are needed for each                                     X2                                     and Xn connection.          |
| One outer IP address is enough in the mixed mode Baseband                                     node.                                                                                                                                                                             | If                                     direct                                     IPsec is used for X2, there must be at least two outer IP                                     addresses in the mixed mode Baseband node in most cases. |

Direct

IPsec for EN-DC

X2,

LTE X2 and

Xn

Direct

IPsec can be enabled in the following ways:

- For both EN-DC X2 and LTE X2
- For EN-DC X2 only
- For Xn independently of X2

It is recommended to enable

direct

IPsec for external EN-DC X2 traffic to meet the strict delay requirements for EN-DC

X2-U.

It is recommended to enable

direct

IPsec for LTE X2 if LTE X2 traffic is delay sensitive. LTE X2 traffic is

delay-sensitive, for example, when inter-eNodeB carrier aggregation is used.

It is recommended to enable direct IPsec for Xn if NR-DC is active to meet the strict

delay requirements for Xn carrying NR-DC.

A mixed mode Baseband can have the following neighbors using

direct

IPsec:

- 512 LTE X2 neighbors: neighbor eNodeBs or LTE in mixed mode Baseband neighbor nodes.
- 256 EN-DC X2 neighbors for LTE: neighbor gNodeBs or NR in mixed mode Baseband neighbor nodes.
- 256 EN-DC X2 neighbors for NR: neighbor eNodeBs or LTE in mixed mode Baseband neighbor nodes.
- 512 Xn neighbors: neighbor gNodeBs or NR in mixed mode Baseband neighbor nodes.

If

direct

IPsec is enabled, there can be one

direct

IPsec VPN connection to each LTE X2

neighbor,

one to each EN-DC X2

neighbor, and

one to each Xn neighbor.

All X2 and Xn

connections can share one

direct

IPsec VPN connection between two mixed mode Baseband neighbor nodes if LTE and NR

share inner VR. The same applies between a mixed mode Baseband node and an

eNodeB or a

gNodeB.

The total number of

direct

IPsec VPN connections is

512. When all

512 direct IPsec VPN connections are established, X2 and Xn traffic to other

neighbors is sent via the

SEG.

If

the total number of LTE X2, EN-DC X2, and Xn neighbors

is expected

to

exceed 512,

the

following actions are

recommended:

- Do not enable the direct IPsec for LTE X2 As a consequence, the risk of running out of direct IPsec VPN connections is less and the EN-DC X2 and Xn traffic can be sent with low latency.
- Do not enable the direct IPsec for Xn if NR-DC is not active If direct IPsec is enabled for EN-DC X2 only, all EN-DC X2 traffic can be sent with low latency.

Multiple

Outer IP Addresses in Mixed Mode Baseband Nodes

LTE and NR must use separate outer IP addresses for direct IPsec if the following

conditions are fulfilled:

- LTE and NR use separate inner VRs in a mixed mode Baseband node.
- There can be more than one X2 or Xn connection using direct IPsec to a neighbor node.

The following are examples when the above apply:

- Two mixed mode Baseband nodes are EN-DC X2 neighbors and they are mutual anchors.
- Direct IPsec is enabled for both LTE X2 and EN-DC X2 and an LTE neighbor is anchor for NR in the mixed mode Baseband node.
- Direct IPsec is enabled for both EN-DC X2 and Xn, and LTE in the mixed mode Baseband node is anchor for an NR neighbor.

If there is only one outer IP address and there are attempts to establish multiple

direct IPsec VPN connections between two nodes, X2 or Xn traffic might be lost

without clear indication on what is wrong.

Single

Direct

IPsec VPN Connection Between Baseband Nodes

Multiple X2 or

Xn connections between two mixed mode Baseband neighbor nodes or a

mixed mode Baseband node and an eNodeB

or a gNodeB

can share a single

direct

IPsec VPN connection if the following preconditions apply:

- LTE and NR share inner VR in the mixed mode Baseband nodes.
- The same outer IP address, or IPsec endpoint, is used in each node.
- Both nodes are running on a software supporting Single Direct IPsec.

If any of these preconditions are not met, each

X2 and

Xn connection requires a separate

direct

IPsec VPN connection. In this case, different outer IP addresses must be used by LTE

and NR in the mixed mode Baseband node.

If LTE and NR share inner VR but some other preconditions

are

not met:

- Separate X2 addresses must be used for LTE X2 and EN-DC X2 in each LTE neighbor.
- Separate addresses must be used for EN-DC X2 and Xn in each NR neighbor.

Shared mixed mode Baseband with LTE and NR in MOCN

A mixed mode Baseband with LTE and NR can be shared between different operators in

the same way as the separate eNodeBs and gNodeBs. The LTE side and NR side of the

mixed mode Baseband can be shared independently.

In the same way as in the separate eNodeBs and gNodeBs, the

direct

IPsec VPN connection is setup for one PLMN for each LTE or NR neighbor. The

selection of inner X2-U

and Xn-U

addresses and outer IPsec endpoints is the same as in the separate

eNodeBs and gNodeBs.

IPv4 for LTE and IPv6 for NR

If LTE use IPv4 and NR use IPv6, there must be at least three inner IP addresses in a

mixed mode Baseband node. For LTE, there is one IPv4 address for S1 and LTE X2, and

one IPv6 address for EN-DC X2. For NR, there is one IPv6

address.

If LTE and NR NSA use IPv4 and NR SA uses IPv6, there can be only one IPv4 address

for LTE. For NR, there is one IPv4 address for X2 and S1 and one IPv6 address for Xn

and NG.

If two mixed mode Baseband nodes are EN-DC X2 neighbors, and LTE and NR use separate

inner VRs, there can be two

direct

IPsec VPN connections for EN-DC X2 between the nodes. If LTE uses IPv4 and NR uses

IPv6 in the outer network in this case, there must be two outer IPv6 addresses in

each mixed mode Baseband neighbor node.

If LTE and NR share inner VR, both IPv4 and IPv6 traffic can be sent through one

IPsec VPN connection to the SEG and through each direct IPsec VPN connection..

Either IPv4 or IPv6 can be used in the outer network.

Direct

IPsec in Deployments with a Mixed Mode Baseband Node with LTE and NR

The following deployments are examples to illustrate the needed configuration when

using

direct

IPsec.

In all described deployments, NR and LTE use separate IP addresses. The same IP

address is used for

S1,

X2, NG, and Xn and for the control and user planes,

and there is no address separation based on PLMN.

In all described deployments, LTE uses IPv4 and NR uses IPv6. There are three inner

addresses in each mixed mode Baseband node. LTE has one IPv4 address for S1 and LTE

X2, and one IPv6 address for EN-DC X2. NR has one IPv6 address for

all

interfaces. It is possible to use the same IP version for both LTE

and NR. In this case, the separate IP address for EN-DC X2 is not needed for

LTE.

- Two mixed mode Baseband neighbor nodes where LTE and NR share inner VR. One IP version is used in the outer network. Both NR NSA and NR SA are included. See Figure 33 When there is a single outer IP address in each node, all X2 and Xn connections can share a single direct IPsec VPN connection.
- Two mixed mode Baseband neighbor nodes where LTE and NR use separate inner VRs. LTE uses IPv4 in outer network and NR uses IPv6. Both NR NSA and NR SA are included. See Figure 34. Each X2 and Xn connection uses a separate direct IPsec VPN connection in this deployment. One additional IPv6 address is needed in the outer network in each mixed mode Baseband node.
- One mixed mode Baseband node with a neighbor eNodeB and a neighbor gNodeB. LTE uses IPv4 in outer network and NR uses IPv6. Only NR NSA is included, no NR SA. See Figure 35. The mixed mode Baseband node does not have another mixed mode Baseband node as EN-DC X2 neighbor in this deployment. One outer IPv6 address is enough in each mixed mode Baseband node if the direct X2 IPsec is not enabled for LTE X2. LTE X2 traffic is sent via the SEG.

Figure 33   Mixed Mode Baseband Neighbor Nodes, LTE and NR Share Inner VR, IPv4 for LTE

and IPv6 for NR, IPv6 in Outer Network

Figure 34   Mixed Mode Baseband Neighbor Nodes, LTE and NR Use Separate Inner VRs, IPv4

for LTE and IPv6 for NR

Figure 35   One Mixed Mode Baseband Node with Neighbor eNodeB and Neighbor gNodeB, LTE

and NR Use Separate Inner VRs, IPv4 for LTE and IPv6 for NR,

Direct

IPsec for EN-DC X2

Only, no

NR SA

Related concepts

Two Mixed Mode Baseband Nodes with LTE and NR Sharing Inner VR, IPv4 for LTE and IPv6 for NR, IPv6 in Outer Network

Two Mixed Mode Baseband Nodes, LTE and NR Use Separate Inner VRs, IPv4 for LTE and IPv6 for NR

One Mixed Mode Baseband Node with a Neighbor eNodeB and a Neighbor gNodeB, LTE and NR Use Separate Inner VRs, IPv4 for LTE and IPv6 for NR, Direct IPsec for EN-DC X2 Only

#### 2.7.3.1 Two Mixed Mode Baseband Nodes with LTE and NR Sharing Inner VR, IPv4 for LTE and IPv6 for NR, IPv6 in Outer Network

In this deployment the following statements apply:

- There are two mixed mode Baseband neighbor nodes with LTE and NR.
- Both nodes use a software that supports single direct IPsec and direct IPsec for Xn.
- The mixed mode Baseband node can have the following nodes as neighbors: eNodeB, gNodeB, another mixed mode Baseband node.
- LTE and NR share inner VR in both nodes.
- LTE and NR share IPsec VPN connection to the security gateway in both nodes.
- LTE uses IPv4 in inner network. NR and EN-DC X2 use IPv6 in inner network. IPv6 is used in the outer network.
- Internal EN-DC X2 is routed internally in the inner VR.
- Direct IPsec is enabled for external EN-DC X2, LTE X2, and Xn.

Figure 36 shows possible X2

and Xn

connections between, and internally in, two mixed mode Baseband

neighbor nodes with LTE and NR. Internal EN-DC X2 traffic is routed internally in the

inner VR. External EN-DC X2

traffic,

LTE X2 traffic,

and Xn traffic are protected by

a single

direct

IPsec VPN connection.

Figure 36   S1 and X2 Traffic in Two Mixed Mode Baseband Neighbor Nodes: Shared Inner VR,

IPv4 for LTE and IPv6 for NR, IPv6 in Outer Network

Figure 37 shows a possible MO configuration in one

of the mixed mode Baseband nodes. MOs of less importance for this deployment are not

displayed.

Figure 37   MO Configuration in One of the Mixed Mode Baseband Neighbor Nodes: Shared Inner

VR, IPv4 for LTE and IPv6 for NR, IPv6 in Outer Network

The IPsec configuration in the mixed mode Baseband node is the same as in eNodeB, with

additions for NR. The following important details are considered about the configuration

in this deployment.. The items in the list correspond to the numbered sections in Figure 37.

1. In the inner Router MO, an IPv6 address and an IPv6 routing table are configured for NR. The IPv6 address for NR is configured with an InterfaceIPv6 MO and an AddressIPv6 MO. The InterfaceIPv6 MO is encapsulated by the same IpsecTunnel MO as the InterfaceIPv4 MO. A separate IpsecPolicy MO must be configured, and the IpsecPolicy.localTrafficSelector attribute for each IpsecPolicy MO must be configured with the LTE RAN IPv4 address and the NR RAN IPv6 address respectively.
2. In the inner Router MO, a separate IPv6 address is configured for the LTE side of the EN-DC X2. This IPv6 address is configured by a loopback InterfaceIPv6 MO and an AddressIPv6 MO. A separate IpsecPolicy MO is configured, and the IpsecPolicy.localTrafficSelector attribute is configured with the EN-DC X2 IPv6 address.
3. A PeerIpsecProfile MO is created in the inner Router MO to set common attributes for direct IPsec. The PeerIpsecProfile MO refers a NodeCredential MO and a TrustCategory MO.
4. For LTE, direct IPsec is enabled for both LTE X2 and EN-DC X2 with the ENodeBFunction.ipsecEpAddressRef attribute. The ENodeBFunction.ipsecEndcEpAddressRef attribute does not need to be set. The same outer address that is used for the IPsec VPN connection to the SEG is used. The ENodeBFunction.X2IpAddrViaS1Active attribute must be set to TRUE to enable exchange of neighbor information for LTE X2.
5. For NR, direct IPsec is enabled for EN-DC X2 and Xn by creating a LocalIpsecEndpoint MO. The LocalIpsecEndpoint.interfaceList attribute includes X2 and Xn, and the LocalIpsecEndpoint.outerIpAddressRef refers to the local outer IP address to be used. The same outer address that is used for the IPsec VPN connection to the SEG is used.
6. To send the NR-DC traffic through the direct IPsec VPN, the following MOs must refer to the same AddressIPv6 MO: The LocalIpEndpoint MO in the GNBDUFunction MO for F1 interface The LocalIpEndpoint MO in the GNBCUUPFunction MO for Xn interface
7. A PeerIpsecTunnel MO and a direct IPsec VPN connection are created automatically when the first X2-C or Xn-C connection to a neighbor node is established. All X2 and Xn connections between the two nodes share PeerIpsecTunnel MO and direct IPsec VPN connection. Separate PeerIpsecTunnel MOs and direct IPsec VPN connections are established to each neighbor node.

Parameter Settings with the ECT

This example configuration can be created using ECT with the parameter settings in

Table 26, Table 27, and Table 28. As LTE uses IPv4 and NR uses IPv6,

LTE and NR can share the IPsec interface in MyInner Router. The IPv6 EN-DC X2

address on LTE side is configured with a separate Loopback Interface in MyInner

Router.

Direct IPsec is enabled on LTE side for both EN-DC X2 and LTE X2 by setting the LTE

Radio Access Settings/Direct IPsec slider to enabled and the LTE Radio Access

Settings/Direct X2 outer address to MyOuter. If Direct IPsec is to be enabled for

EN-DC X2 only, the LTE Radio Access Settings/Direct X2 outer address must not be

set.

Direct IPsec is enabled on NR side for both EN-DC X2 and Xn by setting the NR Radio

Access Settings/Direct IPsec slider to enabled.

Table 26   Router Settings

| Parameter             | Value Instance 1                                      | Value Instance 2   | Value Instance 2   |
|-----------------------|-------------------------------------------------------|--------------------|--------------------|
| Router identity       | MyOuter                                               | MyInner            | MyInner            |
| Interface identity    | 1                                                     | 1                  | ENDC               |
| Interface type        | Physical interface                                    | Ipsec interface    | Loopback interface |
| Physical connector    | TN_A (or other port applicable for selected hardware) | N/A                | N/A                |
| VLAN usage            | Disabled or Enabled                                   | N/A                | N/A                |
| Used outer router     | N/A                                                   | MyOuter            | N/A                |
| IP version            | IPv6                                                  | IPv4_IPv6          | IPv6               |
| Address identity IPv4 | N/A                                                   | LTE                | N/A                |
| Address identity IPv6 | 1                                                     | NR                 | N/A                |

Table 27   LTE Radio Access Settings

| Parameter               | Value        |
|-------------------------|--------------|
| Used router             | MyInner/LTE  |
| Direct IPsec            | Enabled      |
| ENDC IP address         | MyInner/ENDC |
| Direct X2 outer address | MyOuter      |

Table 28   NR Radio Access Settings

| Parameter    | Value      |
|--------------|------------|
| Used router  | MyInner/NR |
| Direct IPsec | Enabled    |

Related concepts

Direct IPsec for X2 in eNodeB

Direct IPsec for X2 and Xn in gNodeB

Direct IPsec in Mixed Mode Baseband Node with LTE and NR

#### 2.7.3.2 Two Mixed Mode Baseband Nodes, LTE and NR Use Separate Inner VRs, IPv4 for LTE and IPv6 for NR

In this deployment the following statements apply:

- There are two mixed mode Baseband neighbor nodes with LTE and NR.
- The mixed mode Baseband node can have the following nodes as neighbors: eNodeB, gNodeB, another mixed mode Baseband node.
- LTE uses IPv4 in both inner and outer networks. NR and EN-DC X2 use IPv6 in both inner and outer networks.
- LTE and NR use separate inner VRs in both nodes.
- LTE and NR have separate IPsec VPN connections to SEG in both nodes.
- LTE and NR share outer VR but use separate outer IP addresses in both nodes.
- Separate outer IPv6 address is used by LTE for direct IPsec for EN-DC X2 on both nodes.
- Internal EN-DC X2 is routed between the inner VRs.
- Direct IPsec is enabled for external EN-DC X2, LTE X2, and Xn.

Figure 38 shows possible X2

and Xn

connections between, and internally in, two mixed mode Baseband

neighbor nodes with LTE and NR. Internal EN-DC X2 traffic is routed between the inner

VRs. External EN-DC X2

traffic,

LTE X2 traffic,

and Xn traffic are protected by

separate

direct

IPsec VPN connections.

Figure 38   S1 and X2 Traffic in Two Mixed Mode Baseband Neighbor Nodes: Separate Inner VRs,

IPv4 for LTE and IPv6 for NR

Figure 39 shows a possible MO configuration in one

of the mixed mode Baseband nodes. MOs of less importance for this deployment are not

displayed.

Figure 39   MO Configuration in One of the Mixed Mode Baseband Neighbor Nodes: Separate Inner

VRs, IPv4 for LTE and IPv6 for NR

The IPsec configuration in the mixed mode Baseband node is the same as in eNodeB, with

additions for NR. The following important details are considered about the configuration

in this deployment. The items in the list correspond to the numbered sections in Figure 39.

1. The same transport configuration is set up for NR as the one for LTE with a separate inner Router MO. IPv6 is used instead of IPv4. Traffic selector configuration is not needed as there is only one AddressIPv6 MO in the inner Router MO for NR. The AddressIPv6 MO in the inner Router MO for NR is referred to by the SctpEndpoint MO for NR, and by the LocalIpEndpoint.addressRef attribute. As separate inner Router MOs are used, there must be separate IpsecTunnel MOs and separate IPsec VPN connections to different SEGs.
2. In the outer Router MO, two IPv6 addresses and an IPv6 routing table are configured. The IPv6 addresses are configured by an InterfaceIPv6 MO with two AddressIPv6 MOs in the outer Router MO. The InterfaceIPv6 MO is encapsulated by the same VlanPort MO as the InterfaceIPv4 MO. One of the IPv6 addresses is used as the outer address for NR, both for the IPsec VPN connection to the security gateway and for direct IPsec. The other IPv6 address is used by LTE for EN-DC X2. A separate PeerIPv6 MO is configured for SEG for NR.
3. In the inner Router MO for LTE, and IPv6 address and an IPv6 routing table are configured for EN-DC X2. The IPv6 address is configured by an InterfaceIPv6 MO and an AddressIPv6 MO. The InterfaceIPv6 MO is encapsulated by the same IpsecTunnel MO as the InterfaceIPv4 MO for LTE. A separate IpsecPolicy MO must be configured, and the IpsecPolicy.localTrafficSelector attribute for each IpsecPolicy MO must be configured with the LTE RAN IPv4 address and the EN-DC X2 IPv6 address respectively.
4. An inter-VR route is created in each inner Router MO. This is done with an additional Dst MO and NextHop MO in each inner Router MO. For LTE, the NR RAN IP is configured in the Dst.dst attribute. The NextHop.reference attribute refers to the inner Router MO for NR. For NR, the LTE EN-DC X2 IP is configured in theDst.dst attribute. The NextHop.reference attribute refers to the inner Router MO for LTE.
5. A PeerIpsecProfile MO must be configured in each inner Router MO to set common properties for direct IPsec. Different properties and certificates can be used for LTE and NR.
6. For LTE, direct IPsec is enabled for both LTE and EN-DC X2. The outer IPv4 address for LTE is configured with the ENodeBFunction.ipsecEpAddressRef attribute. The outer IPv6 address for EN-DC X2 is configured with the ENodeBFunction.ipsecEndcEpAddressRef attribute. TheENodeBFunction.x2IpAddrViaS1Active attribute must be set to TRUE to enable exchange of neighbor information for LTE X2.
7. For NR, direct IPsec is enabled for EN-DC X2 and Xn by creating a LocalIpsecEndpoint MO. The LocalIpsecEndpoint.interfaceList attribute includes X2 and Xn, and the LocalIpsecEndpoint.outerIpAddressRef attribute refers to the local outer IP address to be used. The attribute refers to the same outer address used for the IPsec VPN connection to the SEG.
8. To send the NR-DC traffic through the direct IPsec VPN, the following MOs must refer to the same AddressIPv6 MO: The LocalIpEndpoint MO in the GNBDUFunction MO for F1 interface The LocalIpEndpoint MO in the GNBCUUPFunction MO for Xn
9. A PeerIpsecTunnel MO and a direct IPsec VPN connection are created automatically when the X2-C or Xn-C connection to an external neighbor is established. For each mixed mode Baseband neighbor node, four direct IPsec VPN connections and four PeerIpsecTunnel MOs are possible in the following way:
    - Two of the VPN connections and PeerIpsecTunnel MOs are used for EN-DC X2. One PeerIpsecTunnel MO is created in each inner Router MO.
    - One VPN connection and one PeerIpsecTunnel MO are used for LTE X2. The PeerIpsecTunnel MO is created in the inner Router MO for LTE.
    - One VPN connection and one PeerIpsecTunnel MO are used for Xn. The PeerIpsecTunnel MO is created in the inner Router MO for NR.

Parameter Settings with the ECT

This example configuration can be created using ECT with the parameter settings in

Table 29, Table 30, and Table 31. LTE and NR use separate inner

Router MOs. The IPv6 EN-DC X2 address on LTE side can be configured together with

the IPv4 LTE address for the IPsec interface in MyInnerLTE Router.

Direct IPsec is enabled on LTE side for both EN-DC X2 and LTE X2 by setting the

Direct IPsec slider and Direct X2 outer address in LTE Radio Access Settings. Direct

IPsec for EN-DC X2 uses a separate IPv6 outer address by setting LTE Radio Access

Settings/Direct ENDC outer address.

Direct IPsec is enabled on NR side for both EN-DC X2 and Xn by setting the NR Radio

Access Settings/Direct IPsec slider to enabled.

Note that it is not possible to configure the inter VR route in ECT. If needed, this

must be manually added in the configuration file. The inter VR route is needed to

route internal EN-DC X2 traffic, in case LTE is anchor to NR in the Mixed Mode

Baseband.

Table 29   Router Settings

| Parameter             | Value Instance 1                                      | Value Instance 2   | Value Instance 3   |
|-----------------------|-------------------------------------------------------|--------------------|--------------------|
| Router identity       | MyOuter                                               | MyInnerLTE         | MyInnerNR          |
| Interface identity    | 1                                                     | 1                  | 1                  |
| Interface type        | Physical interface                                    | Ipsec interface    | Ipsec interface    |
| Physical connector    | TN_A (or other port applicable for selected hardware) | N/A                | N/A                |
| VLAN usage            | Disabled or Enabled                                   | N/A                | N/A                |
| Used outer router     | N/A                                                   | MyOuter/1/v4_1     | MyOuter/1/v6_2     |
| IP version            | IPv4_IPv6                                             | IPv4_IPv6          | IPv6               |
| Address identity IPv4 | v4_1                                                  | LTE                | N/A                |
| Address identity IPv6 | v6_1, v6_2                                            | ENDC               | N/A                |

Table 30   LTE Radio Access Settings

| Parameter                 | Value             |
|---------------------------|-------------------|
| Used router               | MyInnerLTE/1/LTE  |
| Direct IPsec              | Enabled           |
| ENDC IP address           | MyInnerLTE/1/ENDC |
| Direct X2 outer address   | MyOuter/1/v4_1    |
| Direct ENDC outer address | MyOuter/1/v6_1    |

Table 31   NR Radio Access Settings

| Parameter    | Value     |
|--------------|-----------|
| Used router  | MyInnerNR |
| Direct IPsec | Enabled   |

Related concepts

Direct IPsec for X2 in eNodeB

Direct IPsec for X2 and Xn in gNodeB

Direct IPsec in Mixed Mode Baseband Node with LTE and NR

#### 2.7.3.3 One Mixed Mode Baseband Node with a Neighbor eNodeB and a Neighbor gNodeB, LTE and NR Use Separate Inner VRs, IPv4 for LTE and IPv6 for NR, Direct IPsec for EN-DC X2 Only

In this deployment the following statements apply:

- There is one mixed mode Baseband node with LTE and NR.
- There is one neighbor eNodeB and one neighbor gNodeB.
- The mixed mode Baseband node does not have any mixed mode Baseband nodes as X2 neighbors, but it can have several eNodeB and gNodeB neighbors.
- LTE uses IPv4 in both inner and outer networks. NR and EN-DC X2 use IPv6 in both inner and outer networks.
- LTE and NR use separate inner VRs in the mixed mode Baseband node.
- LTE and NR have separate IPsec VPN connections to SEG in the mixed mode Baseband node.
- Internal EN-DC X2 is routed between the inner VRs.
- Direct IPsec is enabled for external EN-DC X2 but not for LTE X2.
- There is only NR NSA, no NR SA.

Figure 40 shows possible X2 connections between, and internally

in, a mixed mode Baseband node and the eNodeB and gNodeB neighbors. Internal EN-DC X2

traffic is routed between the inner VRs. External EN-DC X2 traffic is protected by

direct

IPsec VPN connection. LTE X2 traffic is sent through the SEG.

Figure 40   S1 and X2 Traffic in a Mixed Mode Baseband Node with a Neighbor eNodeB and a

Neighbor gNodeB: Separate Inner VRs, IPv4 for LTE and IPv6 for NR,

Direct

IPsec for EN-DC X2 Only

Figure 41 shows a possible MO configuration in the mixed mode

Baseband node. MOs of less importance for this deployment are not displayed.

Figure 41   MO Configuration in the Mixed Mode Baseband Node: Separate Inner VRs, IPv4 for

LTE and IPv6 for NR,

Direct

IPsec for EN-DC X2

Only, no NR

SA

IPsec

configuration in the mixed mode Baseband node is similar to deployments where there is a

mixed mode Baseband neighbor node. The differences are described in

the following list. The items in the list correspond to the numbered sections in Figure 41.

1. In the outer Router MO, there is only one IPv6 address configured. The outer IPv6 address is used for the IPsec VPN connection to the SEG for NR and direct IPsec for EN-DC X2.
2. For LTE, direct IPsec is enabled for EN-DC X2 with the ENodeBFunction.ipsecEndcEpAddressRef attribute. The ENodeBFunction.ipsecEpAddressRef attribute must not be set in this deployment. Because of this, the direct IPsec for LTE is not enabled. LTE X2 traffic is sent through the SEG. There is only one EN-DC X2 connection to each neighbor node because there is only one mixed mode Baseband node. One outer (IPv6) address is enough in the mixed mode Baseband node.
3. Only X2 is included in the LocalIPsecEndpoint.interfaceList attribute, since there is no NR SA. There is only an EN-DC X2 connection to each neighbor gNodeB and no Xn connection. Only one possible direct IPsec VPN connection is set up. One outer IPv6 address is enough in the mixed mode Baseband node.
4. A PeerIpsecTunnel MO, and a direct IPsec VPN connection are created automatically when the X2-C connection is established for EN-DC X2.

Figure 42 shows a possible MO configuration in a neighbor

eNodeB. MOs of less importance for this deployment are not displayed.

Figure 42   MO Configuration in an eNodeB: IPv4 and IPv6

IPsec configuration in the eNode is similar to deployments where the same IP version is

used in all networks. The differences are described in the following list. The items in

the list correspond to the numbered sections in Figure 42.

1. In the inner Router MO, an IPv6 address and an IPv6 routing table are configured for EN-DC X2. The IPv6 address is configured by an InterfaceIPv6 MO and an AddressIPv6 MO. The InterfaceIPv6 MO is encapsulated by the same IpsecTunnel MO as the InterfaceIPv4 MO. This IPv6 address is referred by ENodeBFunction.upEndcX2AddressRef attribute. A separate IpsecPolicy MO must be configured, and the IpsecPolicy.localTrafficSelector attribute for each IpsecPolicy MO must be configured with S1 LTE X2 IPv4 address and the EN-DC X2 IPv6 address respectively.
2. In the outer Router MO, an IPv6 address and an IPv6 routing table are configured. The IPv6 address is configured by an InterfaceIPv6 MO and an AddressIPv6 MO in the outer Router MO. The InterfaceIPv6 MO is encapsulated by the same VlanPort MO as the InterfaceIPv4 MO. The IPv6 address is used as the outer address for direct X2 IPsec for EN-DC X2. Direct IPsec is enabled for EN-DC X2 by configuring the ENodeBFucntion.ipsecEndcEpAddressRef attribute.
3. A PeerIpsecTunnel MO, and a direct IPsec VPN connection are created automatically when the X2-C connection to the EN-DC X2 neighbor is established. If the direct IPsec is also enabled for LTE X2 in the eNodeB, a direct IPsec VPN connection and a PeerIpsecTunnel MO are created for each LTE neighbor where direct IPsec is enabled. It does not include the mixed mode Baseband node in this deployment, as direct IPsec is not enabled for LTE X2 in the mixed mode Baseband node.

In a neighbor gNodeB,

direct

IPsec is configuration in the same if the EN-DC X2 neighbor is an eNodeB or a mixed mode

Baseband node. Only IPv6 addresses are used in the gNodeB.

Parameter Settings with the ECT

This example configuration can be created using ECT with the parameter settings in

Table 32, Table 33, and Table 34. LTE and NR use separate inner

Router MOs. The IPv6 EN-DC X2 address on LTE side can be configured together with

the IPv4 LTE address for the IPsec interface in MyInnerLTE Router.

Direct IPsec is enabled on LTE side for EN-DC X2 only by setting the LTE Radio Access

Settings/Direct IPsec slider to enabled. The IPv6 outer address is specified in LTE

Radio Access Settings/Direct ENDC outer address.

Direct IPsec is enabled on NR side for EN-DC X2 but not Xn by setting the NR Radio

Access Settings/Direct IPsec slider to enabled and specifying NR Radio Access

Settings/Direct ENDC outer address.

Note that it is not possible to configure the inter VR route in ECT. If needed, this

must be manually added in the configuration file. The inter VR route is needed to

route internal EN-DC X2 traffic, in case LTE is anchor to NR in the Mixed Mode

Baseband.

Table 32   Router Settings

| Parameter             | Value Instance 1                                      | Value Instance 2   | Value Instance 3   |
|-----------------------|-------------------------------------------------------|--------------------|--------------------|
| Router identity       | MyOuter                                               | MyInnerLTE         | MyInnerNR          |
| Interface identity    | 1                                                     | 1                  | 1                  |
| Interface type        | Physical interface                                    | Ipsec interface    | Ipsec interface    |
| Physical connector    | TN_A (or other port applicable for selected hardware) | N/A                | N/A                |
| VLAN usage            | Disabled or Enabled                                   | N/A                | N/A                |
| Used outer router     | N/A                                                   | MyOuter/1/v4       | MyOuter/1/v6       |
| IP version            | IPv4_IPv6                                             | IPv4_IPv6          | IPv6               |
| Address identity IPv4 | v4                                                    | LTE                | N/A                |
| Address identity IPv6 | v6                                                    | ENDC               | N/A                |

Table 33   LTE Radio Access Settings

| Parameter       | Value             |
|-----------------|-------------------|
| Used router     | MyInnerLTE/1/LTE  |
| Direct IPsec    | Enabled           |
| ENDC IP address | MyInnerLTE/1/ENDC |

Table 34   NR Radio Access Settings

| Parameter                 | Value        |
|---------------------------|--------------|
| Used router               | MyInnerNR/1  |
| Direct IPsec              | Enabled      |
| Direct ENDC outer address | MyOuter/1/v6 |

Related concepts

Direct IPsec for X2 in eNodeB

Two Mixed Mode Baseband Nodes, LTE and NR Use Separate Inner VRs, IPv4 for LTE and IPv6 for NR

Direct IPsec for X2 and Xn in gNodeB

# 3 Troubleshoot IPsec

This section describes commands and logs that can be used to troubleshoot

IPsec. It is assumed that you have configured IPsec and have IP connectivity

with the security gateway.

## 3.1 Useful Troubleshooting Commands

Table 35 shows useful troubleshooting CLI commands.

In addition to this it is possible to restart the IKE SA by using the action

restartIkeSa on the Ikev2Session MO.

Table 35   Troubleshooting commands

| Command              | MO Class                                                         | Description                                                                                                                                                                                                                                                                                                                           |
|----------------------|------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| show childsa         | Ikev2Session or IpsecPolicy or                   PeerIpsecTunnel | This command shows Child SAs, including negotiated parameters, setup between node                 and security gateway                 (Ikev2Session/IpsecPolicy) or adjacent eNodeB                   (PeerIpsecTunnel). If PFS is used, the command also shows the                 negotiated DH group.                             |
| show counter details | PeerIpsecTunnel                                                  | This command shows detailed PM counters of IKE SA, Child SA and tunnel                 interface.                                                                                                                                                                                                                                     |
| show ikesa           | Ikev2Session or PeerIpsecTunnel                                  | This command shows the parameters negotiated for the IKE SA between the node and                 the security gateway (Ikev2Session) or the adjacent eNodeB                   (PeerIpsecTunnel)  For the Ikev2Session MO this also shows if there if there is a                 NAT device between the node and the security gateway. |
| show tunnel details  | IpsecTunnel or PeerIpsecTunnel                                   | This command shows both the IKEv2 SA and Child SAs for the IPsec VPN                 connection.                                                                                                                                                                                                                                      |
| start                | PacketCapture                                                    | This command starts capturing IKE messages and selected ESP packets of the IPsec VPN connection. In this case capturing is done either at MO IpsecTunnel or MO PeerIpsecTunnel MO.  See also example below table.                                                                                                                     |
| stop                 | PacketCapture                                                    | This command stops capturing IKE messages and selected ESP packets of the IPsec VPN                 connection.                                                                                                                                                                                                                       |
| status               | PacketCapture                                                    | This command shows the current Packet capture status.                                                                                                                                                                                                                                                                                 |

Example 1   CLI Example for start

start --interfaceLdn

"ManagedElement=1,Transport=1,Router=1,IpsecTunnel=1"

start --interfaceLdn

"ManagedElement=1,Transport=1,Router=1,PeerIpsecTunnel=1"

It is also possible to capture packets on the outer InterfaceIPv4 or

AddressIPv6 MO or the inner InterfaceIPv4 or

AddressIPv6 MO.

## 3.2 Log Handling

### 3.2.1 Security Log

The following events are generated and logged in the security log. For each of the event the

local and remote outer addresses are included.

Failed integrity check for a Child SA

This event is generated when there is a failure in the verification of integrity on the IPsec ESP packet. SPI and sequence number are included in the log.

Failed integrity check for an IKE SA

This event is generated when there is a failure in the verification of integrity on the IKE

packet. SPI is included in the log.

Failed anti-replay check

This event is generated when the sequence number of the IPsec ESP packet is out of the Anti-Replay Window. The event is only seen when the Anti-Replay is enabled on the  IpsecPolicy  MO instance. SPI and sequence number are included in the log.

Failed IKE authentication

This event is generated when there is a failure in the authentication

of security gateway during the initial exchange.

Invalid IKE message is received

This event is generated when there is error in the IKE packet and

it cannot be processed.

IKE SA established without CRL check

This event is generated when an IKE SA is kept even though CRL check cannot be done as

relevant CRLs are still not available on the node after 30 seconds. Subject name and serial

number of each certificate in the chain are included in the log.

### 3.2.2 TnNetworkLog

IKE SA and Child SA events are logged in TnNetworkLog with information:

- The time of the SA creation/deletion
- The local and remote outer IP addresses of the IPsec VPN connection
- SPI(s), and old SPI(s) in case of rekeying
- Chosen transforms of the new SA
- Negotiated traffic selectors of the new Child SA

If the peer address is configured as an FQDN, successful DNS query is logged including

local outer address, the FQDN, and all resolved IP addresses (upto 15).

Besides these normal events there are a number of exemption cases that are logged. That

is for example:

- Node certificate expired or there is no subjectAltName in the node certificate.
- FQDN could not be resolved.
- IKE SA negotiation failed for various reasons.
- Child SA could not be created for various reasons.

For all events the local and remote outer addresses are included in the log, and

in some cases additional information is also included.

For information on how to collect the log file, see Manage Software.

### 3.2.3 PacketCaptureLog

When Packet Capture is started on the PacketCapture MO referring either to

IpsecTunnel or PeerIpsecTunnel MO, following packets

of the IPsec VPN connection are logged in the PacketCaptureLog:

- All the decrypted IKE messages
- First 10 ESP packets on each Child SA
- ESP packets with unknown SPI, at a maximum rate of one packet per second

Only the first 40 bytes of each ESP packet (including the IP header) are logged if IPv4 is

used in the outer network. Only the first 60 bytes of each ESP packet (including the IP

header) are logged if IPv6 is used in the outer network.

If Packet Capture is started referring to the outer InterfaceIPv4 or

InterfaceIPv6 MO, the outer IP packets are logged. These packets include

the encrypted IKE and ESP messages. If Packet Capture is started referring to the inner

InterfaceIPv4 or InterfaceIPv6 MO, the inner

unencrypted IP packets are logged.

For more information about Packet Capture, see Transport Network Troubleshooting Guideline.

For information on how to collect the log file, see Manage Transport Network.

# 4 Appendix

## 4.1 IPsec COMCLI Show-config, Configuration Examples

The following configuration examples show the MOs within Transport

that are especially important for IPsec. The examples do not include any MOs outside

Transport.

Example 2   COMCLI Configuration A

```
(Transport=1)>show-config
Transport=1
   EthernetPort=TN_B
      administrativeState=UNLOCKED
      admOperatingMode=10G_FULL
      autoNegEnable=false
      encapsulation="ManagedElement=1,Equipment=1,FieldReplaceableUnit=1,TnPort=TN_B"
      up
   Ikev2PolicyProfile=1
      credential="ManagedElement=1,SystemFunctions=1,SecM=1,CertM=1,NodeCredential=STP_A21_node"
      trustCategory="ManagedElement=1,SystemFunctions=1,SecM=1,CertM=1,TrustCategory=1"
      up
   IpsecProposalProfile=1
      childSaLifetime
         up
      up
   Router=vr_1
      InterfaceIPv4=vr_1_outer_if
         encapsulation="ManagedElement=1,Transport=1,EthernetPort=TN_B"
         AddressIPv4=vr_1_outer_if
            address="10.14.21.35/29"
            up
         up
      PeerIPv4=outer_segw_1
         address="10.14.21.38"
         up
      RouteTableIPv4Static=1
         Dst=1
            dst="0.0.0.0/0"
            NextHop=1
               address="10.14.21.1"
               up
            up
         up
      up
   Router=vr_2
      InterfaceIPv4=vr_2_inner_if
         encapsulation="ManagedElement=1,Transport=1,Router=vr_2,IpsecTunnel=vr_2_inner_if"
         AddressIPv4=vr_2_inner_if
            address="10.14.121.248/32"
            up
         up
      IpsecTunnel=vr_2_inner_if
         localAddress="ManagedElement=1,Transport=1,Router=vr_1,InterfaceIPv4=vr_1_outer_if,AddressIPv4=vr_1_outer_if"
         remoteAddress="ManagedElement=1,Transport=1,Router=vr_1,PeerIPv4=outer_segw_1"
         Ikev2Session=vr_2_inner_if
            ikev2PolicyProfile="ManagedElement=1,Transport=1,Ikev2PolicyProfile=1"
            up
         IpsecPolicy=vr_2_inner_if_1
            ipsecProposalProfile="ManagedElement=1,Transport=1,IpsecProposalProfile=1"
            up
         up
      RouteTableIPv4Static=vr_2
         Dst=vr_2_inner_if
            dst="10.14.121.0/29"
            NextHop=vr_2_inner_if
               reference="ManagedElement=1,Transport=1,Router=vr_2,InterfaceIPv4=vr_2_inner_if"
               up
            up
         up
      up
   Synchronization=1
      up
   up
(Transport=1)>
```

Example 3   COMCLI Configuration B

```
(Transport=1)>show-config
Transport=1
   EthernetPort=TN_B
      administrativeState=UNLOCKED
      admOperatingMode=10G_FULL
      autoNegEnable=false
      encapsulation="ManagedElement=1,Equipment=1,FieldReplaceableUnit=1,TnPort=TN_B"
      up
   Ikev2PolicyProfile=1
      credential="ManagedElement=1,SystemFunctions=1,SecM=1,CertM=1,NodeCredential=STP_A21_node"
      trustCategory="ManagedElement=1,SystemFunctions=1,SecM=1,CertM=1,TrustCategory=1"
      up
   IpsecProposalProfile=1
      childSaLifetime
         up
      up
   Router=vr_1
      InterfaceIPv4=vr_1_outer_if
         encapsulation="ManagedElement=1,Transport=1,EthernetPort=TN_B"
         AddressIPv4=vr_1_outer_if
            address="10.14.21.35/29"
            up
         up
      PeerIPv4=outer_segw_1
         address="10.14.21.38"
         up
      PeerIPv4=outer_segw_2
         address="10.14.21.46"
         up
      RouteTableIPv4Static=1
         Dst=1
            dst="0.0.0.0/0"
            NextHop=1
               address="10.14.21.1"
               up
            up
         up
      up
   Router=vr_2
      InterfaceIPv4=vr_2_inner_if_1
         encapsulation="ManagedElement=1,Transport=1,Router=vr_2,IpsecTunnel=vr_2_inner_if_1"
         AddressIPv4=vr_2_inner_if_1
            address="10.14.121.248/32"
            up
         up
      IpsecTunnel=vr_2_inner_if_1
         localAddress="ManagedElement=1,Transport=1,Router=vr_1,InterfaceIPv4=vr_1_outer_if,AddressIPv4=vr_1_outer_if"
         remoteAddress="ManagedElement=1,Transport=1,Router=vr_1,PeerIPv4=outer_segw_1"
         Ikev2Session=vr_2_inner_if_1
            ikev2PolicyProfile="ManagedElement=1,Transport=1,Ikev2PolicyProfile=1"
            up
         IpsecPolicy=vr_2_inner_if_1
            ipsecProposalProfile="ManagedElement=1,Transport=1,IpsecProposalProfile=1"
            up
         up
      RouteTableIPv4Static=vr_2
         Dst=vr_2_inner_if_1
            dst="10.14.121.0/29"
            NextHop=vr_2_inner_if_1
               reference="ManagedElement=1,Transport=1,Router=vr_2,InterfaceIPv4=vr_2_inner_if_1"
               up
            up
         up
      up
   Router=vr_3
      InterfaceIPv4=vr_3_inner_if_2
         encapsulation="ManagedElement=1,Transport=1,Router=vr_3,IpsecTunnel=vr_3_inner_if_2"
         AddressIPv4=vr_3_inner_if_2
            address="10.14.121.249/32"
            up
         up
      IpsecTunnel=vr_3_inner_if_2
         localAddress="ManagedElement=1,Transport=1,Router=vr_1,InterfaceIPv4=vr_1_outer_if_2,AddressIPv4=vr_1_outer"
         remoteAddress="ManagedElement=1,Transport=1,Router=vr_1,PeerIPv4=outer_segw_2"
         Ikev2Session=vr_3_inner_if_2
            ikev2PolicyProfile="ManagedElement=1,Transport=1,Ikev2PolicyProfile=1"
            up
         IpsecPolicy=vr_3_inner_if_2
            ipsecProposalProfile="ManagedElement=1,Transport=1,IpsecProposalProfile=1"
            up
         up
      RouteTableIPv4Static=vr_3
         Dst=vr_3_inner_if_2
            dst="10.14.121.0/29"
            NextHop=vr_3_inner_if_2
               reference="ManagedElement=1,Transport=1,Router=vr_3,InterfaceIPv4=vr_3_inner_if_2"
               up
            up
         up
      up
   Synchronization=1
      up
   up
(Transport=1)>
```

Example 4   COMCLI Configuration C

```
(Transport=1)>show-config
Transport=1
   EthernetPort=TN_B
      administrativeState=UNLOCKED
      admOperatingMode=10G_FULL
      autoNegEnable=false
      encapsulation="ManagedElement=1,Equipment=1,FieldReplaceableUnit=1,TnPort=TN_B"
      up
   Ikev2PolicyProfile=1
      credential="ManagedElement=1,SystemFunctions=1,SecM=1,CertM=1,NodeCredential=STP_A21_node"
      trustCategory="ManagedElement=1,SystemFunctions=1,SecM=1,CertM=1,TrustCategory=1"
      up
   IpsecProposalProfile=1
      childSaLifetime
         up
      up
   Router=vr_1
      InterfaceIPv4=vr_1_outer_if_1
         encapsulation="ManagedElement=1,Transport=1,VlanPort=outer_if_1"
         AddressIPv4=vr_1_outer_if_1
            address="10.14.21.35/29"
            up
         up
      PeerIPv4=outer_if_1_segw_if_1
         address="10.14.21.38"
         up
      RouteTableIPv4Static=1
         Dst=1
            dst="0.0.0.0/0"
            NextHop=1
               address="10.14.21.1"
               up
            up
         up
      up
   Router=vr_2
      InterfaceIPv4=vr_2_inner_if_1
         encapsulation="ManagedElement=1,Transport=1,Router=vr_2,IpsecTunnel=vr_2_inner_if_1"
         AddressIPv4=vr_2_inner_if_1
            address="10.14.121.248/32"
            up
         up
      IpsecTunnel=vr_2_inner_if_1
         localAddress="ManagedElement=1,Transport=1,Router=vr_1,InterfaceIPv4=vr_1_outer_if_1,AddressIPv4=vr_1_outer_if_1"
         remoteAddress="ManagedElement=1,Transport=1,Router=vr_1,PeerIPv4=outer_if_1_segw_if_1"
         Ikev2Session=vr_2_inner_if_1
            ikev2PolicyProfile="ManagedElement=1,Transport=1,Ikev2PolicyProfile=1"
            up
         IpsecPolicy=vr_2_inner_if_1
            ipsecProposalProfile="ManagedElement=1,Transport=1,IpsecProposalProfile=1"
            up
         up
      RouteTableIPv4Static=vr_2
         Dst=vr_2_inner_if_1
            dst="10.14.121.0/29"
            NextHop=vr_2_inner_if_1
               reference="ManagedElement=1,Transport=1,Router=vr_2,InterfaceIPv4=vr_2_inner_if_1"
               up
            up
         up
      up
   Router=vr_3
      InterfaceIPv4=vr_3_outer_if_2
         encapsulation="ManagedElement=1,Transport=1,VlanPort=outer_if_2"
         AddressIPv4=vr_3_outer_if_2
            address="10.14.21.43/29"
            up
         up
      PeerIPv4=outer_if_2_segw_if_2
         address="10.14.21.46"
         up
      RouteTableIPv4Static=1
         Dst=1
            dst="0.0.0.0/0"
            NextHop=1
               address="10.14.21.1"
               up
            up
         up
      up
   Router=vr_4
      InterfaceIPv4=vr_4_inner_if_2
         encapsulation="ManagedElement=1,Transport=1,Router=vr_4,IpsecTunnel=vr_4_inner_if_2"
         AddressIPv4=vr_4_inner_if_2
            address="10.14.121.249/32"
            up
         up
      IpsecTunnel=vr_4_inner_if_2
         localAddress="ManagedElement=1,Transport=1,Router=vr_3,InterfaceIPv4=vr_3_outer_if_2,AddressIPv4=vr_3_outer_if_2"
         remoteAddress="ManagedElement=1,Transport=1,Router=vr_3,PeerIPv4=outer_if_2_segw_if_2"
         Ikev2Session=vr_4_inner_if_2
            ikev2PolicyProfile="ManagedElement=1,Transport=1,Ikev2PolicyProfile=1"
            up
         IpsecPolicy=vr_4_inner_if_2
            ipsecProposalProfile="ManagedElement=1,Transport=1,IpsecProposalProfile=1"
            up
         up
      RouteTableIPv4Static=vr_4
         Dst=vr_4_inner_if_2
            dst="10.14.121.0/29"
            NextHop=vr_4_inner_if_2
               reference="ManagedElement=1,Transport=1,Router=vr_4,InterfaceIPv4=vr_4_inner_if_2"
               up
            up
         up
      up
   Synchronization=1
      up
   VlanPort=outer_if_1
      encapsulation="ManagedElement=1,Transport=1,EthernetPort=TN_B"
      vlanId=211
      up
   VlanPort=outer_if_2
      encapsulation="ManagedElement=1,Transport=1,EthernetPort=TN_B"
      vlanId=1211
      up
   up
(Transport=1)>
```

Related Information

Configuration A

Configuration B

Configuration C